<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Trent Nelson">
<meta name="description" content="This article takes a look at the new no-GIL, free-threading functionality introduced in Python 3.13, as well as how it compares and performs against PyParallel’s attempt at exploiting multiple CPU cores over ten years ago. Using a demo project named Parallelopedia, we demonstrate the benefits afforded by the new functionality, whereby large data structures (tens to hundreds of gigabytes) are loaded in main memory and then accessed in parallel from Python—a feat not previously possible with the contemporary multiprocessing approach.">

<title>DRAFT: From PyParallel to Python Free-Threading – Trent Nelson</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-fad9f07c6447c7e618f17e3bec6a2d81.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-fad9f07c6447c7e618f17e3bec6a2d81.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e1dca550fcec1e1c7934dca98c281342.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-30d7f8590d48599e5b2d2a1d86e332d2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": true,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-8RPR4XKPEW"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8RPR4XKPEW', { 'anonymize_ip': false});
</script>
<meta name="quarto:status" content="draft">


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="DRAFT: From PyParallel to Python Free-Threading – Trent Nelson">
<meta property="og:description" content="This article takes a look at the new no-GIL, free-threading functionality introduced in Python 3.13, as well as how it compares and performs against PyParallel’s attempt at exploiting multiple CPU cores over ten years ago. Using a demo project named Parallelopedia, we demonstrate the benefits afforded by the new functionality, whereby large data structures (tens to hundreds of gigabytes) are loaded in main memory and then accessed in parallel from Python—a feat not previously possible with the contemporary multiprocessing approach.">
<meta property="og:image" content="https://trent.me/articles/from-pyparallel-to-python-free-threading/images/python-free-threading.png">
<meta property="og:site_name" content="Trent Nelson">
<meta property="og:image:height" content="1024">
<meta property="og:image:width" content="1792">
<meta name="twitter:title" content="DRAFT: From PyParallel to Python Free-Threading – Trent Nelson">
<meta name="twitter:description" content="This article takes a look at the new no-GIL, free-threading functionality introduced in Python 3.13, as well as how it compares and performs against PyParallel’s attempt at exploiting multiple CPU cores over ten years ago. Using a demo project named Parallelopedia, we demonstrate the benefits afforded by the new functionality, whereby large data structures (tens to hundreds of gigabytes) are loaded in main memory and then accessed in parallel from Python—a feat not previously possible with the contemporary multiprocessing approach.">
<meta name="twitter:image" content="https://trent.me/articles/from-pyparallel-to-python-free-threading/images/python-free-threading.png">
<meta name="twitter:image-height" content="1024">
<meta name="twitter:image-width" content="1792">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div>
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Trent Nelson</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../articles/index.html"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects/index.html"> 
<span class="menu-text">Projects &amp; Repos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tools/index.html"> 
<span class="menu-text">Tools</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://twitter.com/trentnelson" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
    <a href="https://github.com/tpn" title="GitHub" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/trent-p-nelson" title="LinkedIn" class="quarto-navigation-tool px-1" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a>
  <ul>
  <li><a href="#greg-steins-free-threaded-patch-1996" id="toc-greg-steins-free-threaded-patch-1996" class="nav-link" data-scroll-target="#greg-steins-free-threaded-patch-1996">Greg Stein’s Free Threaded Patch (1996)</a>
  <ul>
  <li><a href="#python-1.4" id="toc-python-1.4" class="nav-link" data-scroll-target="#python-1.4">Python 1.4</a>
  <ul class="collapse">
  <li><a href="#objects-and-varobjects" id="toc-objects-and-varobjects" class="nav-link" data-scroll-target="#objects-and-varobjects">Objects and VarObjects</a></li>
  <li><a href="#reference-counting" id="toc-reference-counting" class="nav-link" data-scroll-target="#reference-counting">Reference Counting</a></li>
  </ul></li>
  <li><a href="#gregs-free-threaded-approach" id="toc-gregs-free-threaded-approach" class="nav-link" data-scroll-target="#gregs-free-threaded-approach">Greg’s Free-Threaded Approach</a></li>
  </ul></li>
  <li><a href="#pyparallel" id="toc-pyparallel" class="nav-link" data-scroll-target="#pyparallel">PyParallel</a>
  <ul>
  <li><a href="#genesis" id="toc-genesis" class="nav-link" data-scroll-target="#genesis">Genesis</a>
  <ul class="collapse">
  <li><a href="#the-python-ideas-asyncore-discussion" id="toc-the-python-ideas-asyncore-discussion" class="nav-link" data-scroll-target="#the-python-ideas-asyncore-discussion">The python-ideas@ asyncore discussion</a></li>
  <li><a href="#reviewing-existing-attempts" id="toc-reviewing-existing-attempts" class="nav-link" data-scroll-target="#reviewing-existing-attempts">Reviewing Existing Attempts</a></li>
  <li><a href="#the-hunch" id="toc-the-hunch" class="nav-link" data-scroll-target="#the-hunch">The Hunch</a></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a>
  <ul class="collapse">
  <li><a href="#detecting-parallel-threads" id="toc-detecting-parallel-threads" class="nav-link" data-scroll-target="#detecting-parallel-threads">Detecting Parallel Threads</a></li>
  <li><a href="#instrumenting-thread-sensitive-calls" id="toc-instrumenting-thread-sensitive-calls" class="nav-link" data-scroll-target="#instrumenting-thread-sensitive-calls">Instrumenting Thread-Sensitive Calls</a></li>
  <li><a href="#changes-to-pyobject" id="toc-changes-to-pyobject" class="nav-link" data-scroll-target="#changes-to-pyobject">Changes to PyObject</a></li>
  <li><a href="#reference-counting-1" id="toc-reference-counting-1" class="nav-link" data-scroll-target="#reference-counting-1">Reference Counting</a></li>
  <li><a href="#memory-allocation" id="toc-memory-allocation" class="nav-link" data-scroll-target="#memory-allocation">Memory Allocation</a></li>
  <li><a href="#memory-reclaimation" id="toc-memory-reclaimation" class="nav-link" data-scroll-target="#memory-reclaimation">Memory Reclaimation</a></li>
  <li><a href="#garbage-collection" id="toc-garbage-collection" class="nav-link" data-scroll-target="#garbage-collection">Garbage Collection</a></li>
  <li><a href="#async-io" id="toc-async-io" class="nav-link" data-scroll-target="#async-io">Async I/O</a></li>
  </ul></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a>
  <ul class="collapse">
  <li><a href="#parallel-code-has-to-be-entered-via-protocol-callbacks" id="toc-parallel-code-has-to-be-entered-via-protocol-callbacks" class="nav-link" data-scroll-target="#parallel-code-has-to-be-entered-via-protocol-callbacks">Parallel Code Has To Be Entered Via Protocol Callbacks</a></li>
  <li><a href="#you-couldnt-do-a-lot-of-things-in-parallel-callbacks" id="toc-you-couldnt-do-a-lot-of-things-in-parallel-callbacks" class="nav-link" data-scroll-target="#you-couldnt-do-a-lot-of-things-in-parallel-callbacks">You Couldn’t Do A Lot Of Things In Parallel Callbacks</a></li>
  <li><a href="#third-party-libraries-required-recompilation" id="toc-third-party-libraries-required-recompilation" class="nav-link" data-scroll-target="#third-party-libraries-required-recompilation">Third-Party Libraries Required Recompilation</a></li>
  <li><a href="#the-code-was-hideous" id="toc-the-code-was-hideous" class="nav-link" data-scroll-target="#the-code-was-hideous">The Code Was… Hideous</a></li>
  <li><a href="#it-was-windows-only" id="toc-it-was-windows-only" class="nav-link" data-scroll-target="#it-was-windows-only">It Was Windows-only</a>
  <ul class="collapse">
  <li><a href="#thread-pool-apis-and-asynchronous-io" id="toc-thread-pool-apis-and-asynchronous-io" class="nav-link" data-scroll-target="#thread-pool-apis-and-asynchronous-io">Thread Pool APIs and Asynchronous I/O</a></li>
  <li><a href="#visual-studio-debugger" id="toc-visual-studio-debugger" class="nav-link" data-scroll-target="#visual-studio-debugger">Visual Studio Debugger</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#performance" id="toc-performance" class="nav-link" data-scroll-target="#performance">Performance</a></li>
  <li><a href="#more-information" id="toc-more-information" class="nav-link" data-scroll-target="#more-information">More Information</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#python-free-threading" id="toc-python-free-threading" class="nav-link" data-scroll-target="#python-free-threading">Python Free-Threading</a>
  <ul>
  <li><a href="#implementation-1" id="toc-implementation-1" class="nav-link" data-scroll-target="#implementation-1">Implementation</a>
  <ul>
  <li><a href="#changes-to-pyobject-1" id="toc-changes-to-pyobject-1" class="nav-link" data-scroll-target="#changes-to-pyobject-1">Changes to PyObject</a>
  <ul class="collapse">
  <li><a href="#python-3.13-pyobject" id="toc-python-3.13-pyobject" class="nav-link" data-scroll-target="#python-3.13-pyobject">Python 3.13 PyObject</a></li>
  <li><a href="#free-threaded-pyobject" id="toc-free-threaded-pyobject" class="nav-link" data-scroll-target="#free-threaded-pyobject">Free-Threaded PyObject</a>
  <ul class="collapse">
  <li><a href="#object-thread-id-uintptr_t-ob_tid" id="toc-object-thread-id-uintptr_t-ob_tid" class="nav-link" data-scroll-target="#object-thread-id-uintptr_t-ob_tid">Object Thread ID: <code>uintptr_t ob_tid</code></a></li>
  <li><a href="#reference-counts-ob_ref_local-and-ob_ref_shared" id="toc-reference-counts-ob_ref_local-and-ob_ref_shared" class="nav-link" data-scroll-target="#reference-counts-ob_ref_local-and-ob_ref_shared">Reference Counts: <code>ob_ref_local</code> and <code>ob_ref_shared</code></a></li>
  <li><a href="#per-object-locking-pymutex-ob_mutex" id="toc-per-object-locking-pymutex-ob_mutex" class="nav-link" data-scroll-target="#per-object-locking-pymutex-ob_mutex">Per-Object Locking: <code>PyMutex ob_mutex</code></a></li>
  <li><a href="#garbage-collection-state-ob_gc_bits" id="toc-garbage-collection-state-ob_gc_bits" class="nav-link" data-scroll-target="#garbage-collection-state-ob_gc_bits">Garbage Collection State: <code>ob_gc_bits</code></a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#parallelopedia" id="toc-parallelopedia" class="nav-link" data-scroll-target="#parallelopedia">Parallelopedia</a>
  <ul>
  <li><a href="#http-server" id="toc-http-server" class="nav-link" data-scroll-target="#http-server">HTTP Server</a></li>
  <li><a href="#wiki-server" id="toc-wiki-server" class="nav-link" data-scroll-target="#wiki-server">Wiki Server</a></li>
  </ul></li>
  <li><a href="#pytorch-and-free-threading" id="toc-pytorch-and-free-threading" class="nav-link" data-scroll-target="#pytorch-and-free-threading">PyTorch and Free-Threading</a>
  <ul>
  <li><a href="#training-a-local-gpt2" id="toc-training-a-local-gpt2" class="nav-link" data-scroll-target="#training-a-local-gpt2">Training a local GPT2</a></li>
  <li><a href="#multi-threaded-inference" id="toc-multi-threaded-inference" class="nav-link" data-scroll-target="#multi-threaded-inference">Multi-threaded Inference</a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a>
  <ul>
  <li><a href="#pyparallel-backstory" id="toc-pyparallel-backstory" class="nav-link" data-scroll-target="#pyparallel-backstory">PyParallel Backstory</a>
  <ul>
  <li><a href="#becoming-a-python-committer" id="toc-becoming-a-python-committer" class="nav-link" data-scroll-target="#becoming-a-python-committer">Becoming a Python Committer</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#colophon" id="toc-colophon" class="nav-link" data-scroll-target="#colophon">Colophon</a>
  <ul>
  <li><a href="#quarto-markdown" id="toc-quarto-markdown" class="nav-link" data-scroll-target="#quarto-markdown">Quarto &amp; Markdown</a></li>
  <li><a href="#ai-tooling" id="toc-ai-tooling" class="nav-link" data-scroll-target="#ai-tooling">AI Tooling</a>
  <ul>
  <li><a href="#lm-studio" id="toc-lm-studio" class="nav-link" data-scroll-target="#lm-studio">LM Studio</a></li>
  <li><a href="#aider" id="toc-aider" class="nav-link" data-scroll-target="#aider">Aider</a></li>
  </ul></li>
  <li><a href="#pytorch-deep-neural-networks-llms-and-andrej-karpathys-youtube-series" id="toc-pytorch-deep-neural-networks-llms-and-andrej-karpathys-youtube-series" class="nav-link" data-scroll-target="#pytorch-deep-neural-networks-llms-and-andrej-karpathys-youtube-series">PyTorch, Deep Neural Networks, LLMs, and Andrej Karpathy’s YouTube Series</a></li>
  </ul></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/tpn/website/edit/main/articles/from-pyparallel-to-python-free-threading/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/tpn/website/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DRAFT: From PyParallel to Python Free-Threading</h1>
<p class="subtitle lead">Optimally Exploiting Multiple Cores with Python</p>
  <div class="quarto-categories">
    <div class="quarto-category">Python</div>
    <div class="quarto-category">PyParallel</div>
    <div class="quarto-category">Free-threading</div>
    <div class="quarto-category">No-GIL</div>
    <div class="quarto-category">PyTorch</div>
    <div class="quarto-category">asyncio</div>
  </div>
  </div>

<div>
  <div class="description">
    <p>This article takes a look at the new no-GIL, free-threading functionality introduced in Python 3.13, as well as how it compares and performs against PyParallel’s attempt at exploiting multiple CPU cores over ten years ago. Using a demo project named Parallelopedia, we demonstrate the benefits afforded by the new functionality, whereby large data structures (tens to hundreds of gigabytes) are loaded in main memory and then accessed in parallel from Python—a feat not previously possible with the contemporary <code>multiprocessing</code> approach.</p>
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Trent Nelson </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>

<nav id="TOC-body" role="doc-toc">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction">Introduction</a></li>
  <li><a href="#background" id="toc-background">Background</a>
  <ul>
  <li><a href="#greg-steins-free-threaded-patch-1996" id="toc-greg-steins-free-threaded-patch-1996">Greg Stein’s Free Threaded Patch (1996)</a>
  <ul>
  <li><a href="#python-1.4" id="toc-python-1.4">Python 1.4</a>
  <ul>
  <li><a href="#objects-and-varobjects" id="toc-objects-and-varobjects">Objects and VarObjects</a></li>
  <li><a href="#reference-counting" id="toc-reference-counting">Reference Counting</a></li>
  </ul></li>
  <li><a href="#gregs-free-threaded-approach" id="toc-gregs-free-threaded-approach">Greg’s Free-Threaded Approach</a></li>
  </ul></li>
  <li><a href="#pyparallel" id="toc-pyparallel">PyParallel</a>
  <ul>
  <li><a href="#genesis" id="toc-genesis">Genesis</a>
  <ul>
  <li><a href="#the-python-ideas-asyncore-discussion" id="toc-the-python-ideas-asyncore-discussion">The python-ideas@ asyncore discussion</a></li>
  <li><a href="#reviewing-existing-attempts" id="toc-reviewing-existing-attempts">Reviewing Existing Attempts</a></li>
  <li><a href="#the-hunch" id="toc-the-hunch">The Hunch</a></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation">Implementation</a>
  <ul>
  <li><a href="#detecting-parallel-threads" id="toc-detecting-parallel-threads">Detecting Parallel Threads</a></li>
  <li><a href="#instrumenting-thread-sensitive-calls" id="toc-instrumenting-thread-sensitive-calls">Instrumenting Thread-Sensitive Calls</a></li>
  <li><a href="#changes-to-pyobject" id="toc-changes-to-pyobject">Changes to PyObject</a></li>
  <li><a href="#reference-counting-1" id="toc-reference-counting-1">Reference Counting</a></li>
  <li><a href="#memory-allocation" id="toc-memory-allocation">Memory Allocation</a></li>
  <li><a href="#memory-reclaimation" id="toc-memory-reclaimation">Memory Reclaimation</a></li>
  <li><a href="#garbage-collection" id="toc-garbage-collection">Garbage Collection</a></li>
  <li><a href="#async-io" id="toc-async-io">Async I/O</a></li>
  </ul></li>
  <li><a href="#limitations" id="toc-limitations">Limitations</a>
  <ul>
  <li><a href="#parallel-code-has-to-be-entered-via-protocol-callbacks" id="toc-parallel-code-has-to-be-entered-via-protocol-callbacks">Parallel Code Has To Be Entered Via Protocol Callbacks</a></li>
  <li><a href="#you-couldnt-do-a-lot-of-things-in-parallel-callbacks" id="toc-you-couldnt-do-a-lot-of-things-in-parallel-callbacks">You Couldn’t Do A Lot Of Things In Parallel Callbacks</a></li>
  <li><a href="#third-party-libraries-required-recompilation" id="toc-third-party-libraries-required-recompilation">Third-Party Libraries Required Recompilation</a></li>
  <li><a href="#the-code-was-hideous" id="toc-the-code-was-hideous">The Code Was… Hideous</a></li>
  <li><a href="#it-was-windows-only" id="toc-it-was-windows-only">It Was Windows-only</a>
  <ul>
  <li><a href="#thread-pool-apis-and-asynchronous-io" id="toc-thread-pool-apis-and-asynchronous-io">Thread Pool APIs and Asynchronous I/O</a></li>
  <li><a href="#visual-studio-debugger" id="toc-visual-studio-debugger">Visual Studio Debugger</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#performance" id="toc-performance">Performance</a></li>
  <li><a href="#more-information" id="toc-more-information">More Information</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#python-free-threading" id="toc-python-free-threading">Python Free-Threading</a>
  <ul>
  <li><a href="#implementation-1" id="toc-implementation-1">Implementation</a>
  <ul>
  <li><a href="#changes-to-pyobject-1" id="toc-changes-to-pyobject-1">Changes to PyObject</a>
  <ul>
  <li><a href="#python-3.13-pyobject" id="toc-python-3.13-pyobject">Python 3.13 PyObject</a></li>
  <li><a href="#free-threaded-pyobject" id="toc-free-threaded-pyobject">Free-Threaded PyObject</a>
  <ul>
  <li><a href="#object-thread-id-uintptr_t-ob_tid" id="toc-object-thread-id-uintptr_t-ob_tid">Object Thread ID: <code>uintptr_t ob_tid</code></a></li>
  <li><a href="#reference-counts-ob_ref_local-and-ob_ref_shared" id="toc-reference-counts-ob_ref_local-and-ob_ref_shared">Reference Counts: <code>ob_ref_local</code> and <code>ob_ref_shared</code></a></li>
  <li><a href="#per-object-locking-pymutex-ob_mutex" id="toc-per-object-locking-pymutex-ob_mutex">Per-Object Locking: <code>PyMutex ob_mutex</code></a></li>
  <li><a href="#garbage-collection-state-ob_gc_bits" id="toc-garbage-collection-state-ob_gc_bits">Garbage Collection State: <code>ob_gc_bits</code></a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#parallelopedia" id="toc-parallelopedia">Parallelopedia</a>
  <ul>
  <li><a href="#http-server" id="toc-http-server">HTTP Server</a></li>
  <li><a href="#wiki-server" id="toc-wiki-server">Wiki Server</a></li>
  </ul></li>
  <li><a href="#pytorch-and-free-threading" id="toc-pytorch-and-free-threading">PyTorch and Free-Threading</a>
  <ul>
  <li><a href="#training-a-local-gpt2" id="toc-training-a-local-gpt2">Training a local GPT2</a></li>
  <li><a href="#multi-threaded-inference" id="toc-multi-threaded-inference">Multi-threaded Inference</a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix">Appendix</a>
  <ul>
  <li><a href="#pyparallel-backstory" id="toc-pyparallel-backstory">PyParallel Backstory</a>
  <ul>
  <li><a href="#becoming-a-python-committer" id="toc-becoming-a-python-committer">Becoming a Python Committer</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#colophon" id="toc-colophon">Colophon</a>
  <ul>
  <li><a href="#quarto-markdown" id="toc-quarto-markdown">Quarto &amp; Markdown</a></li>
  <li><a href="#ai-tooling" id="toc-ai-tooling">AI Tooling</a>
  <ul>
  <li><a href="#lm-studio" id="toc-lm-studio">LM Studio</a></li>
  <li><a href="#aider" id="toc-aider">Aider</a></li>
  </ul></li>
  <li><a href="#pytorch-deep-neural-networks-llms-and-andrej-karpathys-youtube-series" id="toc-pytorch-deep-neural-networks-llms-and-andrej-karpathys-youtube-series">PyTorch, Deep Neural Networks, LLMs, and Andrej Karpathy’s YouTube Series</a></li>
  </ul></li>
  <li><a href="#comments" id="toc-comments">Comments</a></li>
  </ul>
</nav>
<p>This article is sponsored by <a href="https://meta.com">Meta</a> in collaboration with <a href="https://quansight.com">Quansight</a> and <a href="https://openteams.com">OpenTeams</a>.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Since it’s inception, Python has had a <a href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">Global Interpreter Lock</a>, or GIL, that prevented more than one thread running Python code at the same time.</p>
<p>Python 3.13, released in October 2024, is the first version of Python to introduce support for a “no-GIL” <em>free-threaded</em> mode, per <a href="https://peps.python.org/pep-0703/">PEP-703 Making the Global Interpreter Lock Optional in CPython</a>, unlocking the ability for multiple Python threads to run simultaneously.</p>
<p>This allows, for the first time since the language’s inception in December 1989, a single Python process to saturate all CPU cores in parallel with pure Python code (i.e.&nbsp;not farming out to extension modules written in C, C++, or, more recently, Rust).</p>
<p>I can’t overstate how exciting this is! For decades, countless attempts have been made to solve this problem—including my own efforts with <a href="https://pyparallel.org">PyParallel</a>—but no-one has prevailed in getting a solution mainlined into CPython. Until now!</p>
<p>I will admit I am biased: I am a Python committer (though I have not been directly involved in this work, nor have I contributed any changes to Python recently), I adore the language, and have spent years obsessing over the dream of a parallel Python. It’s a topic I’m incredibly passionate about, and this article will unabashedly proselytize the extraordinary engineering efforts that finally made a free-threaded Python a reality.</p>
<p>Thankfully, it’s not just blind, uninformed enthusiasm. Over the past few months I’ve had the opportunity to extensively test-drive free-threaded Python to prepare for this article. The verdict? I think it’s phenomenal. Both the implementation and performance on real-world problems. Free-threaded Python removes a significant limitation, making it possible to tackle a wide range of problems that were previously out of reach. I genuinely believe this is the best thing to ever happen to the Python language over the last three decades, and it will solidify its position as one of the most dominant programming languages for the next three decades. After all, we’re not getting fewer cores.</p>
<p>And this is essentially just the first-pass! Certain trade-offs had to be made to deliver the core functionality within a reasonable time frame—like disabling the non-thread-safe functionality introduced by <a href="https://docs.python.org/3/whatsnew/3.11.html#whatsnew311-pep659">PEP-659 Specializing Adaptive Interpreter</a>, which is the feature responsible for delivering large speedups in the last few prior releases. However, this is on track to be re-enabled in free-threaded mode for Python 3.14, allowing multi-threaded code to also benefit from the same speedups single-threaded code has enjoyed the past few years.</p>
<p>The goal of this article is to review the technical details of the implementation, with some comparisons to prior work such as PyParallel. I’ll then cover the types of problems that are now incredibly well-suited to be tackled with a free-threaded Python, using a demo project I’ve created called <a href="https://github.com/tpn/parallelopedia">Parallelopedia</a> to provide a basis for concrete examples of real-world problems.</p>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<p>The <a href="https://peps.python.org/pep-0703/#related-work">Related Work</a> section of PEP-703 does a fantastic job of capturing all of the past attempts at improving Python’s ability at simultaneously leveraging multiple CPU cores.</p>
<p>In this section I’m going to focus on Greg Stein’s initial free-threaded work back in 1996, and then my attempts around 2012 with PyParallel.</p>
<section id="greg-steins-free-threaded-patch-1996" class="level2">
<h2 class="anchored" data-anchor-id="greg-steins-free-threaded-patch-1996">Greg Stein’s Free Threaded Patch (1996)</h2>
<p>The first attempt to remove the GIL was by Greg Stein in 1996, with a patch against Python 1.4. (1996! I hadn’t even heard of Python back in 1996—I was only in tenth grade at the time.)</p>
<p>The <code>python-dev@</code> mailing lists weren’t public until a few years after that, so we can’t see the specific discussions that were had between core Python developers at the time. Greg opines on the experience in August 2001 in this <code>python-dev@</code> email titled <a href="https://mail.python.org/pipermail/python-dev/2001-August/017099.html">Free threading</a>. Guido van Rossum also furnishes some pertinent information on the topic in this September 2007 post titled <a href="https://www.artima.com/forums/flat.jsp?forum=106&amp;thread=214235&amp;start=0&amp;msRange=15">It isn’t Easy to Remove the GIL</a>.</p>
<p>Greg’s approach introduced fine-grained locking to all Python objects, which, unfortunately, introduced pretty severe performance penalties that were deemed too great for the patches to ever make it into mainline Python. With the patches applied, <em>all</em> Python code was slowed down by about 40%-50%, regardless of whether it was single-threaded or multi-threaded code.</p>
<p>Fast-forward 15 years or so, and David Beazley wrote a detailed post in August 2011 about Greg Stein’s work in an article titled: <a href="https://dabeaz.blogspot.com/2011/08/inside-look-at-gil-removal-patch-of.html">An Inside Look at the GIL Removal Patch of Lore</a>. As part of this article, Dave obtains the original Python 1.4 source, applies Greg Stein’s patches, and takes the resulting free-threaded Python for a run.</p>
<p>Dave confirms that, indeed, the slowdown introduced by this approach—where every increment and decrement reference results in either an interlocked op or a mutex lock and unlock—is prohibitively expensive.</p>
<p>In writing this article, I reviewed Dave’s article again, and attempted to download Python 1.4 so that I could apply Greg’s patches as well. Unfortunately, the download link Dave cites now 404s, so I googled <em>“download Python 1.4 source”</em>, and, funnily enough, the first hit is a Github repo titled <a href="https://github.com/tpn/python-1.4">tpn/python-1.4</a> that, ’lo and behold, is a repo I put together twelve years ago doing exactly that:</p>
<ul>
<li><a href="https://github.com/tpn/python-1.4/commit/c6ef13ae4c089eaf8c39942655d65953e6849469">Importing the original Python 1.4 source</a></li>
<li><a href="https://github.com/tpn/python-1.4/commit/5c17e33224e2b57948ab594280a006d7648347e6">Applying Greg’s patches</a></li>
</ul>
<section id="python-1.4" class="level3">
<h3 class="anchored" data-anchor-id="python-1.4">Python 1.4</h3>
<p>Let’s take a look at Python 1.4 and the changes Greg made in the first known effort of someone attempting to remove the Python GIL. All future efforts at this herculean task were influenced by Greg’s work—specifically, in that he identified what absolutely doesn’t work—so it’s valuable to review the core technical aspects of his free-threading patch.</p>
<section id="objects-and-varobjects" class="level4">
<h4 class="anchored" data-anchor-id="objects-and-varobjects">Objects and VarObjects</h4>
<p>Python’s main object structure, the <code>PyObject</code>, hasn’t changed much over the years. For non-container objects (i.e.&nbsp;scalars such as integers, floats, etc.) the structure is simply a reference count and a pointer to a type object:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ob_refcnt<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    PyTypeObject <span class="op">*</span>ob_type<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyObject<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Container objects–otherwise known as <em>“variable”</em> objects–are represented via the <code>PyVarObject</code> structure. These structures <em>“inherit”</em> the base <code>PyObject</code> layout, and then add an additional field for tracking the number of elements contained by the object: the <code>ob_size</code> field. In Python 1.4, the structure looked like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ob_refcnt<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    PyTypeObject <span class="op">*</span>ob_type<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ob_size<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyVarObject<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-simple callout-note no-icon callout-titled" title="Actual C Header Code">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Actual C Header Code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The actual C header code for defining these structures is more baroque; the relevant Python 1.4 <a href="https://github.com/tpn/python-1.4/blob/c6ef13ae4c089eaf8c39942655d65953e6849469/Include/object.h#L104">Include/object.h</a> code looks like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define PyObject_HEAD </span><span class="op">\</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="dt">int</span><span class="pp"> ob_refcnt</span><span class="op">;</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">struct</span><span class="pp"> _typeobject </span><span class="op">*</span><span class="pp">ob_type</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define PyObject_HEAD_INIT</span><span class="op">(</span><span class="pp">type</span><span class="op">)</span><span class="pp"> </span><span class="dv">1</span><span class="op">,</span><span class="pp"> type</span><span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define PyObject_VAR_HEAD </span><span class="op">\</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="pp">    PyObject_HEAD </span><span class="op">\</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="dt">int</span><span class="pp"> ob_size</span><span class="op">;</span><span class="pp"> </span><span class="co">/* Number of items in variable part */</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> _object <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    PyObject_HEAD</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyObject<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    PyObject_VAR_HEAD</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> varobject<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="reference-counting" class="level4">
<h4 class="anchored" data-anchor-id="reference-counting">Reference Counting</h4>
<p>There was no cyclic garbage collection in Python 1.4–that feature wasn’t added until Python 2.0 around the October 2000 timeframe. Reference counting was the only means for Python to reclaim the memory used by objects that were no longer needed, by way of the <code>PyObject</code> <code>ob_refcnt</code> field. Incrementing the reference simply added one to the existing value. Decrementing the reference subtracted one and checked to see if the resulting value was zero, and, if it was, the object would be deallocated via <code>_Py_Dealloc()</code>.</p>
<p>The relevant Python 1.4 <a href="https://github.com/tpn/python-1.4/blob/c6ef13ae4c089eaf8c39942655d65953e6849469/Include/object.h#L349C1-L354C18">Include/object.h</a> code used two macros named <code>Py_INCREF()</code> and <code>Py_DECREF()</code>, which looked like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_INCREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt</span><span class="op">++)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_DECREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp">           </span><span class="op">\</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">if</span><span class="pp"> </span><span class="op">(--(</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt </span><span class="op">!=</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="op">;</span><span class="pp">                       </span><span class="op">\</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">else</span><span class="pp">                        </span><span class="op">\</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="pp">        _Py_Dealloc</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These operations are inherently unsafe in a multi-threaded environment. If two or more separate threads are incrementing or decrementing reference counts to the same object in parallel, the results are effectively undefined, as there is no guarantee as to the correctness of the underlying value.</p>
<p>The solution for protecting against this was the Global Interpreter Lock, which ensured that only one thread could be running Python code at any given time.</p>
<p>Thus, if you’re embarking on an attempt to avoid this restriction, such that you can have multiple Python threads executing Python code simultaneously (i.e. on multi-core systems), the first thing you need to do is figure out how you’re going to handle making reference counting thread-safe.</p>
</section>
</section>
<section id="gregs-free-threaded-approach" class="level3">
<h3 class="anchored" data-anchor-id="gregs-free-threaded-approach">Greg’s Free-Threaded Approach</h3>
<p>Greg’s approach tried the most logical solution: make reference counting a thread-safe operation by using interlocked increment and decrement operations against the <code>ob_refcnt</code> field on NT (Windows) systems. On Linux, a mutex lock was used to protect the reference count.</p>
<p>Using a <code>WITH_FREE_THREAD</code> macro to gate his changes, Greg modified the <a href="https://github.com/tpn/python-1.4/commit/5c17e33224e2b57948ab594280a006d7648347e6#diff-87272721a5cf1cd9915d6f503f6a7bbefa2f26c935c7ce83ca78706afd0ad05aR353-R371">reference counting logic</a> to <code>Include/object.h</code> as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef WITH_FREE_THREAD</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_INCREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> Py_SafeIncr</span><span class="op">(&amp;(</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt</span><span class="op">)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_DECREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp">                       </span><span class="op">\</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">if</span><span class="pp"> </span><span class="op">(</span><span class="pp">Py_SafeDecr</span><span class="op">(&amp;(</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt</span><span class="op">)</span><span class="pp"> </span><span class="op">!=</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="op">;</span><span class="pp">                                   </span><span class="op">\</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">else</span><span class="pp">                                    </span><span class="op">\</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="pp">        _Py_Dealloc</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#else </span><span class="co">/* !WITH_FREE_THREAD */</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_INCREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt</span><span class="op">++)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_DECREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp">           </span><span class="op">\</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">if</span><span class="pp"> </span><span class="op">(--(</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt </span><span class="op">!=</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="op">;</span><span class="pp">                       </span><span class="op">\</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="cf">else</span><span class="pp">                        </span><span class="op">\</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="pp">        _Py_Dealloc</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif </span><span class="co">/* !WITH_FREE_THREAD */</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So, <code>Py_INCREF(op)</code> became a call to <code>Py_SafeIncr()</code>, and <code>Py_DECREF(op)</code> became a call to <code>Py_SafeDecr()</code>. On Windows, these routines were simply wrappers around the <code>InterlockedIncrement</code> and <code>InterlockedDecrement</code> intrinsics, respectively, defined <a href="https://github.com/tpn/python-1.4/commit/5c17e33224e2b57948ab594280a006d7648347e6#diff-9ed9e47e6055e8799816e87f812a456d9d5f37bf32a1973377777184266ff39fR93-R94">here</a>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_SafeIncr</span><span class="op">(</span><span class="pp">pint</span><span class="op">)</span><span class="pp">   InterlockedIncrement</span><span class="op">((</span><span class="dt">long</span><span class="pp"> </span><span class="op">*)(</span><span class="pp">pint</span><span class="op">))</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_SafeDecr</span><span class="op">(</span><span class="pp">pint</span><span class="op">)</span><span class="pp">   InterlockedDecrement</span><span class="op">((</span><span class="dt">long</span><span class="pp"> </span><span class="op">*)(</span><span class="pp">pint</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On non-NT systems, the <code>Py_SafeIncr()</code> and <code>Py_SafeDecr()</code> routines were aliased to <code>_Py_SafeIncr()</code> and <code>_Py_SafeDecr()</code>, respectively, which were implemented in <a href="https://github.com/tpn/python-1.4/commit/5c17e33224e2b57948ab594280a006d7648347e6#diff-3cb31d5133324b025a026d66a2800f91d58736e296776e9f3c24360106eff142R51-R71">Python/pymutex.c</a> as follows:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* mutexes for the subsystems */</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>PyMutex <span class="op">*</span> _Py_RefMutex<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>PyMutex <span class="op">*</span> _Py_ListMutex<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>PyMutex <span class="op">*</span> _Py_MappingMutex<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>PyMutex <span class="op">*</span> _Py_CritMutex<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> _Py_SafeIncr<span class="op">(</span>pint<span class="op">)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>pint<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> result<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    PyMutex_Lock<span class="op">(</span>_Py_RefMutex<span class="op">);</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="op">++*</span>pint<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    PyMutex_Unlock<span class="op">(</span>_Py_RefMutex<span class="op">);</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> _Py_SafeDecr<span class="op">(</span>pint<span class="op">)</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>pint<span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> result<span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    PyMutex_Lock<span class="op">(</span>_Py_RefMutex<span class="op">);</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="op">--*</span>pint<span class="op">;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    PyMutex_Unlock<span class="op">(</span>_Py_RefMutex<span class="op">);</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Oof! That’s a single global mutex <code>_Py_RefMutex</code> protecting all reference counts for all objects. (N.B. <code>PyMutex</code> was a slim wrapper around <code>pthread_mutex_t</code>, and the lock and unlock operations simply called out to <code>pthread_mutex_lock()</code> and <code>pthread_mutex_unlock()</code> respectively.)</p>
<p>Compared to simply incrementing a value in memory by one, locking and unlocking a mutex is orders of magnitude more expensive, so it’s not surprising that this approach to removing the GIL introduced brutal slowdowns—not just to new multi-threaded code, but to existing single-threaded code that wasn’t even taking advantage of the fact that there was now no GIL in place.</p>
<p>Nevertheless, Greg’s work tackled a lot of other important concepts which were mainlined into Python, like separating global state into per-thread state (something that is still relied upon today).</p>
</section>
</section>
<section id="pyparallel" class="level2">
<h2 class="anchored" data-anchor-id="pyparallel">PyParallel</h2>
<section id="genesis" class="level3">
<h3 class="anchored" data-anchor-id="genesis">Genesis</h3>
<section id="the-python-ideas-asyncore-discussion" class="level4">
<h4 class="anchored" data-anchor-id="the-python-ideas-asyncore-discussion">The python-ideas@ asyncore discussion</h4>
<p>In October 2012, there was a discussion on the <code>python-ideas@</code> mailing list titled <a href="https://mail.python.org/pipermail/python-ideas/2012-October/016311.html">asyncore: included batteries don’t fit</a>. The general discussion centered around providing better asynchronous I/O primitives in Python 3.4, and eventually led to the <code>async</code> and <code>yield from</code> keywords being introduced in Python 3.5, released around two years later in September 2015.</p>
<p>That thread was also the genesis for <a href="https://pyparallel.org">PyParallel</a>; a fork of Python 3.3.5 that I created to implement a proof-of-concept version of the Python interpreter that tackled not only asynchronous I/O but also multi-core parallelism.</p>
<p>There’s a comprehensive <a href="#pyparallel-backstory">backstory</a> section on PyParallel at the end of this article that goes into more detail. For now, I just want to focus on the implementation details of PyParallel compared to Greg Stein’s earlier work, before discussing the free-threading implementation we now have today in Python 3.13t.</p>
</section>
<section id="reviewing-existing-attempts" class="level4">
<h4 class="anchored" data-anchor-id="reviewing-existing-attempts">Reviewing Existing Attempts</h4>
<p>I remember reading David Beazley’s <a href="https://dabeaz.blogspot.com/2011/08/inside-look-at-gil-removal-patch-of.html">article</a> and a couple of YouTube videos he’d also done on the topic of the GIL. I can’t remember if it was in one of his videos (or presentations) or articles, but I remember him stating something along the lines of <em>“the GIL is something every Python committer should be worried about”</em>, and that really stuck with me, giving me the initial motivation to embark on the PyParallel project.</p>
<p>The first step I took was to make sure I reviewed Greg’s earlier work to see what did and didn’t work in the past. Clearly, introducing fine-grained per-object synchronization for reference counts was prohibitively expensive—the interlocked increment and decrement operations alone were bad enough, let alone the global <code>pthread_mutex_t</code> reference count locks.</p>
</section>
<section id="the-hunch" class="level4">
<h4 class="anchored" data-anchor-id="the-hunch">The Hunch</h4>
<p>So, what else could we try? My hunch was that there was a way to achieve parallelism within the Python interpreter when framed through the lens of asynchronous I/O primitives, such as a TCP/IP socket server. For example, why couldn’t a simple HTTP server be written in such a way that multiple threads could respond to incoming client requests on multiple cores simultaneously?</p>
<p>If you think about the type of server-side computation that is required to process an incoming HTTP request, it’s just pretty vanilla Python code. Sure, you may create a lot of temporary Python objects in servicing the request, but they’re only short-lived. Once you send a response back to the client, you don’t need any of those objects anymore. And you’re generally not mutating global state, so you don’t need any thread synchronization primitives during request processing.</p>
<p>The underlying operating system’s kernel is handling all of that for you behind the scenes (i.e.&nbsp;you can safely <code>accept()</code> on multiple threads against the same <code>sockaddr_in</code> on Linux, or <code>AcceptEx()</code> against a single completion port on Windows).</p>
</section>
</section>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
<p>So, as it pertained to reference counting and garbage collection—all thread-sensitive things that need to be handled very carefully in a GIL-less Python—with PyParallel, I explored the notion of: <em>what if we just didn’t do any of that in parallel thread contexts</em>?</p>
<p>That is, instead of trying to remove the GIL, let’s keep the GIL, and instead, introduce a new concept of a <em>parallel thread</em>. Because if we can come up with an efficient way to determine if we’re a <em>parallel thread</em> at any given time, we can instrument all the thread-sensitive calls like <code>Py_INCREF()</code> and <code>Py_DECREF()</code> such that:</p>
<ul>
<li>If we’re a <em>parallel thread</em>, do X, if not, do Y.
<ul>
<li>X: a thread-safe alternative</li>
<li>Y: what we normally do (i.e.&nbsp;when we’re holding the GIL)</li>
</ul></li>
</ul>
<p>And as the thread-sensitive calls we need to instrument are ubiquitous—you really can’t do much in Python before needing to <code>Py_INCREF()</code> or <code>Py_DECREF()</code> something—the viability of this approach would be entirely contingent upon finding an efficient way to detect if we’re a parallel thread.</p>
<section id="detecting-parallel-threads" class="level4">
<h4 class="anchored" data-anchor-id="detecting-parallel-threads">Detecting Parallel Threads</h4>
<p>I introduced a macro named <code>Py_PXCTX()</code> for PyParallel that was responsible for detecting if we were in one of these <em>parallel threads</em> (or <em>parallel contexts</em> as I referred to them in the source code).</p>
<p>As PyParallel was a Windows-only proof-of-concept, I was able to leverage an x64 intrinsic named <code>readgsdword</code> to interrogate the current thread’s TEB (<a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb">Thread Environment Block</a>) to obtain the current thread ID (which lives at offset <code>0x48</code> on x64 Windows). By comparing this to the known thread ID of the <em>main thread</em> (i.e.&nbsp;the thread holding the GIL), we could determine if we were a parallel thread with a couple of instructions.</p>
<p>A simplified <a href="https://github.com/pyparallel/pyparallel/blob/branches/3.3-px/Include/pyintrinsics.h#L13">implementation</a> looked like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _Py_get_current_thread_id</span><span class="op">()</span><span class="pp"> </span><span class="op">(</span><span class="pp">__readgsdword</span><span class="op">(</span><span class="bn">0x48</span><span class="op">))</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>_PyParallel_IsParallelContext<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>Py_MainThreadId <span class="op">!=</span> _Py_get_current_thread_id<span class="op">());</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_PXCTX</span><span class="op">()</span><span class="pp"> </span><span class="op">(</span><span class="pp">_PyParallel_IsParallelContext</span><span class="op">())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="instrumenting-thread-sensitive-calls" class="level4">
<h4 class="anchored" data-anchor-id="instrumenting-thread-sensitive-calls">Instrumenting Thread-Sensitive Calls</h4>
<p>With the ability to quickly determine if we were a parallel thread, we could instrument all of the thread-sensitive calls to follow the aforementioned paradigm of:</p>
<blockquote class="blockquote">
<p>If we’re a <em>parallel thread</em>, do X, if not, do Y.</p>
</blockquote>
<p>For reference counting, the <em>do X</em> was literally: <em>do nothing</em>. E.g., instead of the standard Python reference counting mechanics that basically looked like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_INCREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt</span><span class="op">++)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_DECREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="op">(--(</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt </span><span class="op">==</span><span class="pp"> </span><span class="dv">0</span><span class="pp"> </span><span class="op">?</span><span class="pp"> _Py_Dealloc</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">:</span><span class="pp"> </span><span class="op">;)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The PyParallel approach would gate the reference counting logic with the <code>Py_PXCTX()</code> macro, along these lines:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_INCREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">(!</span><span class="pp">Py_PXCTX</span><span class="op">()</span><span class="pp"> </span><span class="op">&amp;&amp;</span><span class="pp"> </span><span class="op">((</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt</span><span class="op">++))</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define Py_DECREF</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="op">(!</span><span class="pp">Py_PXCTX</span><span class="op">()</span><span class="pp"> </span><span class="op">&amp;&amp;</span><span class="pp"> </span><span class="op">(--(</span><span class="pp">op</span><span class="op">)-&gt;</span><span class="pp">ob_refcnt </span><span class="op">==</span><span class="pp"> </span><span class="dv">0</span><span class="pp"> </span><span class="op">?</span><span class="pp"> _Py_Dealloc</span><span class="op">(</span><span class="pp">op</span><span class="op">)</span><span class="pp"> </span><span class="op">:</span><span class="pp"> </span><span class="op">;))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is a purposefully-simplified example—the actual <code>Py_INCREF(op)</code> and <code>Py_DECREF(op)</code> calls in PyParallel eventually grew debug guards that allowed me to catch erroneous cases of, for example, the main thread attempting to mutate the reference count of an object created by a parallel thread.</p>
<p>And in order to ascertain if any given object was created by the Python <em>main thread</em>, or one of these new <em>parallel thread contexts</em>, I had to augument the <code>PyObject</code> structure to capture additional state information.</p>
</section>
<section id="changes-to-pyobject" class="level4">
<h4 class="anchored" data-anchor-id="changes-to-pyobject">Changes to PyObject</h4>
<p>I made three changes to <code>PyObject</code>:</p>
<ol type="1">
<li>A field I could fill with a sentinel value that unambiguously indicated <a href="https://apps.npr.org/arrested-development/joke-39.html">from whence it came</a> (i.e.&nbsp;a main thread or parallel thread): <code>void *is_px</code>.</li>
<li>A flags field I could store pertinent per-object state in: <code>size_t px_flags</code>.</li>
<li>A pointer to the object’s original type object: <code>PyTypeObject *orig_type</code>. In some situations, we would override an object’s type with a parallel-specific shim type that could intercept certain operations.</li>
</ol>
<p>Technically, the <code>is_px</code> field was redundant once I introduced the <code>px_flags</code> field, as we could track whether or not an object was a parallel object by way of a single flag bit, so I could have shaved off 8 bytes by removing it.</p>
<p>I kept it in because a) I never got around to removing it, and b) it was helpful when debugging, as the <code>is_px</code> field was initialized to one of two <code>0xDEADBEEF</code>-style sentinel values, shown below, which made it very easy to eyeball in the debugger when traipsing through memory or crash dumps.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _Py_DEADBEEF </span><span class="bn">0xdead1234beef5678</span><span class="pp"> </span><span class="co">/* is_px when main thread */</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _Px_DEADBEEF </span><span class="bn">0x9876beef5432dead</span><span class="pp"> </span><span class="co">/* is_px when parallel thread */</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A side-by-side comparison of the 64-bit Python 3.3 <code>PyObject</code> structure and the equivalent PyParallel <code>PyObject</code> structure is shown below:</p>
<div class="side-by-side-struct-layout">
<section id="python-pyobject" class="level5 side-by-side-struct-column">
<h5 class="anchored" data-anchor-id="python-pyobject">Python PyObject</h5>
<div class="struct-layout">
<div class="struct-cell py-field" style="grid-column: span 8;">
<pre>Py_ssize_t ob_refcnt
(8 bytes)</pre>
</div>
<div class="struct-cell py-field" style="grid-column: span 8;">
<pre>PyTypeObject *ob_type
(8 bytes)</pre>
</div>
</div>
</section>
<section id="pyparallel-pyobject" class="level5 side-by-side-struct-column">
<h5 class="anchored" data-anchor-id="pyparallel-pyobject">PyParallel PyObject</h5>
<div class="struct-layout">
<div class="struct-cell px-field" style="grid-column: span 8;">
<pre>void *is_px
(8 bytes)</pre>
</div>
<div class="struct-cell px-field" style="grid-column: span 8;">
<pre>size_t px_flags
(8 bytes)</pre>
</div>
<div class="struct-cell px-field" style="grid-column: span 8;">
<pre>PyTypeObject *orig_type
(8 bytes)</pre>
</div>
<div class="struct-cell py-field" style="grid-column: span 8;">
<pre>Py_ssize_t ob_refcnt
(8 bytes)</pre>
</div>
<div class="struct-cell py-field" style="grid-column: span 8;">
<pre>PyTypeObject *ob_type
(8 bytes)</pre>
</div>
</div>
</section>
</div>
<p>The standard Python 3.3 <code>PyObject</code> structure size on 64-bit platforms was 16 bytes. The PyParallel <code>PyObject</code> changes introduced three 64-bit, 8-byte fields—an extra 24 bytes—for a combined total of 40 bytes.</p>
<p>When coming up with a solution for a parallel Python (that doesn’t experience prohibitive slowdown compared to normal Python code), there are four main things you need to focus on handling, which we’ll cover in the next sections:</p>
<ol type="1">
<li>Reference counting.</li>
<li>Memory allocation.</li>
<li>Memory reclamation.</li>
<li>Garbage collection.</li>
</ol>
</section>
<section id="reference-counting-1" class="level4">
<h4 class="anchored" data-anchor-id="reference-counting-1">Reference Counting</h4>
<p>My hunch regarding reference counting was simple: <em>let’s just not do it and see what happens</em>. Such rigorous engineering! Again, I was keen on targeting the very narrow domain of an asynchronous I/O-based TCP/IP socket server, like a HTTP server, where none of the objects that are created as part of servicing an incoming request need to persist once we’ve sent bytes back on the wire to the client.</p>
<p>Additionally, if you think about the flow of a Python program that launches a HTTP server, you’ll have a main thread that does all of the module importing, setting up any global state, handling configuration, command line arguments, etc. Once all of that is done, it’ll launch the HTTP server, and use some form of event loop that allows it to serve incoming clients <em>forever</em>, until process termination.</p>
<p>The code responsible for handling those incoming client requests is very reactionary: you identify what path the client is requesting, figure out how you’re going to <em>route</em> that request (i.e.&nbsp;are they asking for a literal file system file, or is this an endpoint that will be serviced by Python code?), and then respond to it accordingly.</p>
<p>You’re not mutating global state (such as adding values to a global or non-local container object (<code>list</code>, <code>dict</code>, etc.)) in these callbacks.</p>
<p>Finally, you can be assured that for all of the objects you rely upon as part of your request processing (i.e.&nbsp;HTTP URL parsing libraries, application configuration objects, etc.), by the time you’re interacting with those objects in your callback: a) they will have reference counts way above one, and b) there won’t be any other code running that could possibly result in those reference counts ever hitting zero. Those objects are effectively <em>immortal</em> for the duration of your parallel callback, as far as you’re concerned.</p>
<p>So who cares about incrementing and decrementing reference counts for objects we know are guaranteed to stay resident throughout the duration of our parallel callback? By avoiding reference counting entirely, we eliminate the need to figure out a way to increment and decrement reference counts between shared objects in a thread-safe manner—which was the death-knell of Greg Stein’s approach in 1996.</p>
<p>But what about reference counts for objects we create solely during our parallel thread callbacks? Remember, the whole point of an object’s reference count is to ensure the object <em>“stays alive”</em> until it is no longer needed, with <em>“no longer needed”</em> being unambiguously indicated when an object’s reference count hits zero.</p>
<p>However, because our parallel callback code has a very finite and well-defined lifetime, all we really need to ensure is that all of the objects we create in these parallel contexts stay alive for the duration of the callback.</p>
<p>That is, we know our parallel context starts when, for example, we call the user’s <code>data_received()</code> routine, and we know it ends when that routine returns bytes back to us which we then send back to the client.</p>
<p>As long as we can intercept the memory allocation and reclamation routines in these parallel contexts, we can precisely control object lifetime without the need for reference counting.</p>
</section>
<section id="memory-allocation" class="level4">
<h4 class="anchored" data-anchor-id="memory-allocation">Memory Allocation</h4>
<p>So, when I hit the point I needed to write a thread-safe memory allocator that would kick-in to service memory allocation requests in these parallel contexts, I picked the easiest thing I could think of: just give each parallel thread its own thread-local block allocator. This allocator would furnish all memory allocation requests that we intercepted by instrumenting calls like <code>PyObject_New</code> and <code>PyMem_Malloc</code>.</p>
<p>Block allocators are about the simplest memory allocator you can have: you have a pre-allocated block of memory (say, 4KB, or one page), a request comes in for 120 bytes, you capture the address of the current block pointer, increment it by 120 bytes, then return the captured address. If you exceeded 4KB, another page would be allocated and linked to the existing page, such that you’d have a doubly-linked-list of blocks from which allocations would be carved out.</p>
<p>Prior to executing the user’s callback via <code>PyObject_CallObject()</code> in a parallel thread, we would issue a <code>snapshot = PxContext_HeapSnapshot(ctx)</code>, which would <em>“snapshot”</em> the state of the block allocator prior to executing the user’s Python code in parallel; we would then be able to restore this <code>snapshot</code> upon completion of that code.</p>
</section>
<section id="memory-reclaimation" class="level4">
<h4 class="anchored" data-anchor-id="memory-reclaimation">Memory Reclaimation</h4>
<p>How do you free memory associated with individual objects allocated in these parallel contexts? Well, because you’re not doing any reference counting, you have no knowledge of when any given object is no longer required at any arbitrary point within a parallel callback’s execution.</p>
<p>And even if you did, because you’re using a block allocator that isn’t built to handle unused allocations being returned to it, there isn’t anything you could do anyway.</p>
<p>However, what you do know, with absolute certainty, is when that user’s parallel callback has finished executing, because you’ll be sitting back in the Python interpreter’s C code, having just returned from a call to a routine like <code>PyObject_CallObject()</code>.</p>
<p>And because you captured a snapshot of the thread-local block allocator (or heap) via <code>snapshot = PxContext_HeapSnapshot(ctx)</code>, prior to your call to <code>result = PyObject_CallObject(...)</code>, once you’re finished handling the returned <code>result</code> (i.e.&nbsp;sending it back to the client via a socket <code>send()</code> call), you can reset the block allocator back to its starting position prior to the call via <code>PxContext_RollbackHeap(ctx, snapshot)</code>, effectively reclaiming all memory allocated in that parallel context in one fell swoop.</p>
<p>This all worked pretty well for PyParallel. I believe it was the first time anyone had experimented with the notion of <em>“let’s just not do any reference counting and see what happens”</em>, and I was genuinely pleased that my hunch that it would all work out turned out to be true.</p>
<p>Additionally, as back-to-back execution of callbacks on the same thread would be continually using the same block allocator, and thus, the same blocks and corresponding virtual addresses—you’d reap all the benefits you’d expect from frequently using the same addresses: increased likelihood of cache hits and TLB hits, vastly-reduced likelihood of page faults.</p>
<p>This all worked because socket-server callbacks are pretty short-lived; you’re not allocating gobs of memory for objects with ambiguous lifetimes. You’re doing lots of little allocations with very clear lifetimes: the allocations will cease to exist once the callback returns.</p>
<p>It wasn’t perfect. You obviously couldn’t persist the objects past the lifetime of the parallel callback, as that memory was getting continually reset. And if you had a stray callback allocating a disproportionately high amount of memory, you’d end up with many page-sized blocks chained together that would have no way of getting returned to the operating system when no longer needed.</p>
<p>But as far as proof-of-concepts go, it all worked pretty well. The last thing to tackle was garbage collection.</p>
</section>
<section id="garbage-collection" class="level4">
<h4 class="anchored" data-anchor-id="garbage-collection">Garbage Collection</h4>
<p>A nice side-effect of not doing any reference counting is that you can’t create cyclic references between objects in the first place, which obviates the need to do any garbage collection. Thus, PyParallel’s solution for handling parallel garbage collection is simply: don’t do it, it’s not needed.</p>
</section>
<section id="async-io" class="level4">
<h4 class="anchored" data-anchor-id="async-io">Async I/O</h4>
<p>The workhorse of PyParallel was the <a href="https://github.com/pyparallel/pyparallel/blob/branches/3.3-px/Python/pyparallel.c#L8603-L10642">PxSocket_IoLoop</a>, some 2,000+ lines of hideous C state-machine-esque hackery that drove the <em>completion-oriented</em> protocol callbacks implemented by the user.</p>
<p>The protocol objects you had to use for PyParallel were similar to the current-day <a href="https://docs.python.org/3/library/asyncio-protocol.html#protocols">Protocol</a> Python objects used by <code>asyncio</code>.</p>
<p>An example of what a TCP/IP socket server might look like in PyParallel follows. Note that no <code>transport.send()</code> routines were exposed, if you wanted to send bytes back to the client, you literally had to return a Python <code>bytes</code> object from your callback—this would then be sent back to the client in the most optimal fashion.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyProtocol:</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Used if you want to send static bytes to the client first.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    initial_bytes_to_send <span class="op">=</span> <span class="st">b'Hello (Server v1.0)'</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> connection_made(<span class="va">self</span>, transport):</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Used if you need to send dynamic bytes to the client</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># as soon as they connect.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">b'Hello, the current time is '</span> <span class="op">+</span> time.gmtime()</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> data_received(<span class="va">self</span>, transport, data):</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Called when data is received from the client.  Perform</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># your request processing here and then return bytes to</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># send back to the client.</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">b'You sent: '</span> <span class="op">+</span> data</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> connection_lost(<span class="va">self</span>, transport):</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Called when the client disconnects.</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the TCP/IP socket server object (PxSocket).  (PyParallel</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># initially exposed all of its parallel functionality by way of an</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co"># `async` module, which obviously predated the introduction of the</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co"># `async` keyword in Python, so the following code wouldn't be</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># valid in a modern Python 3.5+ context.)</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>server <span class="op">=</span> <span class="cf">async</span>.server(<span class="st">'0.0.0.0'</span>, <span class="dv">8080</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Register the server (transport) and protocol with the underlying</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co"># async machinery.  Note that this will start serving clients</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co"># immediately, without waiting for `async.run()`.</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span>.register(transport<span class="op">=</span>server, protocol<span class="op">=</span>MyProtocol)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Enter the async I/O loop.</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span>.run()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations</h3>
<p>PyParallel, was, in essence, a proof-of-concept project I predominantly hacked together over the course of about three months during a very cold Michigan Winter in 2012-2013.</p>
<p>It had many limitations, especially the first pass in that 2012-2013 timeframe. I spent a few months sprinting on it again around 2015, and addressed some of the egregious limitations like not being able to use generators in parallel contexts, and not being able to persist objects created within a parallel context outside of that context (i.e.&nbsp;<code>foo['key'] = bar</code>, where <code>foo</code> is a <code>dict</code> created in the <em>main thread</em> context).</p>
<p>I also got it to a point where it could compete in a subset of the <a href="https://www.techempower.com/benchmarks/#hw=ph&amp;test=fortune&amp;section=data-r22">TechEmpower Framework Benchmarks</a>, including non-trivial ones like accessing a <code>PyODBC</code> data source in a parallel context.</p>
<p>Nevertheless, the remaining limitations relegated PyParallel to being somewhat similar to <a href="https://en.wikipedia.org/wiki/Stackless_Python">Stackless Python</a>, which was a nichè variant of Python that separated the C call stack from the Python call stack, but never had a chance of getting mainlined into Python.</p>
<p>(Unlike Stackless, though, which had actual users like <a href="https://en.wikipedia.org/wiki/Eve_Online">Eve Online</a>, I am not aware of anyone using PyParallel for anything. I certainly never got any support requests for it.)</p>
<p>The next few sections capture some of the limitations that I presume kept PyParallel from becoming anything other than a proof-of-concept. Thankfully I have the luxury of writing about the failures some ten years after I wrote the underlying code, so I’m inherently less defensive about its egregious shortcomings as I would have been back then.</p>
<section id="parallel-code-has-to-be-entered-via-protocol-callbacks" class="level4">
<h4 class="anchored" data-anchor-id="parallel-code-has-to-be-entered-via-protocol-callbacks">Parallel Code Has To Be Entered Via Protocol Callbacks</h4>
<p>By design, I never intended to support <em>“free-threaded”</em> Python, i.e.&nbsp;you would never be able to create Python <code>threading.Thread</code> objects yourself, instead, you’d have to use the machinery provided to you by PyParallel, such as <code>async.server()</code>, <code>async.submit_work()</code>, etc. (This was before <code>async</code> became a keyword in Python.)</p>
<p>The fact that the only thing that really worked properly was a TCP/IP-based socket server speaks volumes to the lack of general applicability of the solution.</p>
</section>
<section id="you-couldnt-do-a-lot-of-things-in-parallel-callbacks" class="level4">
<h4 class="anchored" data-anchor-id="you-couldnt-do-a-lot-of-things-in-parallel-callbacks">You Couldn’t Do A Lot Of Things In Parallel Callbacks</h4>
<p>You couldn’t import modules in parallel callbacks. This wasn’t a huge limitation, you’d simply work around this by making sure you import all the modules you need at startup, before you launch your server.</p>
<p>You couldn’t call routines of modules that used a lot of caching. Pandas is a great example of this: there is a prolific amount of behind-the-scenes caching that happens in Pandas (or at least the version I was experimenting with circa 2015) when interacting with <code>DataFrame</code> objects. This just flat-out did not work in PyParallel—trying to persist parallel objects past the callback lifetime completely went against the grain of how PyParallel was initially architected to work.</p>
<p>You couldn’t leverage PyParallel to, for example, load large data structures in parallel. Because there was no free-threading support, nor was memory allocated in these parallel callback contexts intended to persist after the callback completed—you couldn’t spin up a bunch of threads to load some expensive data structures in parallel (i.e.&nbsp;reading pickles, etc.).</p>
<p>This is actually one of the patterns that I have enjoyed exploiting the most in the new free-threaded Python as its such a huge win for very little effort. I’ll cover this more later.</p>
</section>
<section id="third-party-libraries-required-recompilation" class="level4">
<h4 class="anchored" data-anchor-id="third-party-libraries-required-recompilation">Third-Party Libraries Required Recompilation</h4>
<p>As PyParallel was based off Python 3.3, a lot of the great work that has since been done regarding sanitizing the Python C ABI wasn’t done yet, so modules with C code doing raw <code>Py_INCREF()</code> and <code>Py_DECREF()</code> calls would need to be recompiled to ensure they use the new PyParallel definitions.</p>
<p>This particular limitation is no different to the current state of affairs with Python free-threading: modules that need intimiate knowledge of C Python internals need to be recompiled at the very least, and sometimes will need additional code changes to ensure correct behavior when operating in a No-GIL environment.</p>
</section>
<section id="the-code-was-hideous" class="level4">
<h4 class="anchored" data-anchor-id="the-code-was-hideous">The Code Was… Hideous</h4>
<p>I hadn’t looked at the <a href="https://github.com/pyparallel/pyparallel/blob/branches/3.3-px/Python/pyparallel.c">pyparallel.c</a> code in a long time prior to writing this article. Boy, it doesn’t hold up particularly well, in my opinion. It’s very clearly hacky proof-of-concept code that realistically had no chance of getting mainlined into Python.</p>
<p>You can peruse all of the changes required to convert Python 3.3.5 into PyParallel by reviewing the <a href="https://github.com/pyparallel/pyparallel/tree/branches/3.3-px/diffs">diffs</a> folder, which I populated with diffs against base 3.3.5 sources and PyParallel counterparts. The patches to files like <a href="https://github.com/pyparallel/pyparallel/blob/branches/3.3-px/diffs/Include/object.h.patch">Include/object.h</a> I find most interesting, as they contain most of the <em>“thread-sensitive interception”</em> functionality I was reliant upon.</p>
</section>
<section id="it-was-windows-only" class="level4">
<h4 class="anchored" data-anchor-id="it-was-windows-only">It Was Windows-only</h4>
<p>I attribute the <em>success</em> of PyParallel—if we define success as being able to hack together a proof-of-concept that basically worked in about 2-3 months—to Windows. There are a couple of reasons for this, which I’ll capture in the next sections.</p>
<p>Ironically, I suspect the Windows-only aspect also contributed heavily to the <em>failure</em> of PyParallel, given that, as far as I’m aware, no-one played around or experimented with it, and it basically didn’t seem to move the GIL needle at all. (Although I was pleased to see it at least got a shout-out in the <a href="https://peps.python.org/pep-0703/#related-work">Related Work</a> section of PEP-703, and there are parallels (heh) to some of the design decisions I made for PyParallel in the new Free-Threading work.)</p>
<p>I thought at the time that it would be novel and interesting enough to nerd-snipe a few people into downloading it and messing around, but apparently not.</p>
<p>I do remember some engineers from Instagram reaching out and asking about the viability of PyParallel on Linux, but alas, I didn’t have a good answer for that, given how heavily dependent it was on Windows-only features.</p>
<section id="thread-pool-apis-and-asynchronous-io" class="level5">
<h5 class="anchored" data-anchor-id="thread-pool-apis-and-asynchronous-io">Thread Pool APIs and Asynchronous I/O</h5>
<p>First, I made extensive use of the phenomenal <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/thread-pool-api">Thread Pool API</a> introduced in Windows Vista. It is hard to succinctly capture just how sophisticated this particular API is, especially when paired with the NT kernel’s incredibly robust asynchronous I/O primitives, particularly the seminal <code>OVERLAPPED</code> structure and the <a href="https://learn.microsoft.com/en-us/windows/win32/fileio/i-o-completion-ports">Completion Port</a> scaffolding.</p>
<p>If you’re interesting in learning more about asynchronous I/O on Windows, <a href="https://speakerdeck.com/trent/pyparallel-how-we-removed-the-gil-and-exploited-all-cores?slide=47">slide 47</a> of my PyParallel PyData 2013 deck is a great place to start.</p>
<p>So, I used the thread pool facilities to manage all thread dispatching for PyParallel. I didn’t have to create any threads myself, nor did I ever intend to support individual Python <em>free-threading</em> threads created via Python’s <code>threading.Thread</code> facilities. There are simply no good cross-platform threadpool alternatives that have equivalent functionality to what is provided by Windows, and a lot of that is because other operating systems just don’t have the kernel mechanisms in place to support things like thread-agnostic I/O, or true asynchronous I/O at the driver level via I/O request packets (or <code>Irps</code> as they’re colloquially called in kernel development circles). Neither Wine nor ReactOS have attempted to implement the Windows Thread Pool API, which I also found to be an interesting data point.</p>
<p>For the TCP/IP socket-server primary use case, enabled by the <code>PxSocket_IoLoop()</code> workhorse described earlier, overlapped-versions of all the socket primitives were used where possible. There aren’t any exact equivalents to these functions on platforms like Linux, the BSDs, or Mac OS.</p>
<p>All of those platforms support non-blocking read and write socket operations—which is the foundation upon which concurrency is achieved when combined with a multiplexing operation like <code>select()</code>, <code>poll()</code>, <code>epoll()</code>, or <code>kqueue</code>. But there is no way to dispatch a socket <code>read()</code> or <code>write()</code> call <em>asynchronously</em> in conjunction with a request for the OS to invoke a callback you provide when that asynchronous operation completes (or fails).</p>
<p>Nor do any of these platforms have anything remotely close to the secret sauce behind what makes I/O completion ports so special: the ability to specify a completion port’s desired concurrency, where the kernel itself will ensure that an optimal number of threads will be actively scheduled whilst servicing a completion port. I touch on this subject a little bit on <a href="https://speakerdeck.com/trent/pyparallel-how-we-removed-the-gil-and-exploited-all-cores?slide=50">slide 50</a>, and go into more detail around <a href="https://speakerdeck.com/trent/pyparallel-how-we-removed-the-gil-and-exploited-all-cores?slide=62">slide 62</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>io_uring</code> is an exception: it absolutely allows asynchronous submission of a whole range of system calls, but it doesn’t introduce a thread-agnostic I/O model, nor have any kernel participation in concurrency modulation like I/O completion ports, nor have any native thread pool integration (as there is no equivalent to the Windows Thread Pool API on any platform, Linux included).</p>
<p>Generally, leveraging <code>io_uring</code> in a multi-threaded environment on a contemporary Linux system would involve spinning up your own threads and setting up individual completion queues for each thread. There’s no concept of multiple threads sharing a queue in a kernel-integrated, thread-agnostic manner. Which is fine, as that’s a very Windows NT kernel solution to the problem—it just isn’t how UNIX-derived operating systems are designed to work.</p>
<p>I am not disparaging <code>io_uring</code> in the slightest here; it is a fantastic additional to the Linux kernel that is orders of magnitude better than prior options for async I/O.</p>
<p>The point of mentioning all of this is that there isn’t feature parity between <code>io_uring</code> and the Windows features I leveraged in making PyParallel, so it would still require significant engineering effort to port PyParallel to non-Windows platforms. And thankfully that’s not something we’ll ever have to embark upon, as the cross-platform Python Free-Threading implementation is a far better solution to the multi-core Python problem than PyParallel ever was!</p>
<p>(Also, for what it’s worth, <code>io_uring</code> wasn’t available in 2012 when I started hacking on PyParallel; it first appeared in the Linux kernel 5.1 in May 2019.)</p>
</div>
</div>
<p>The point of all of this is to convey that PyParallel wasn’t just Windows-only because I didn’t have the time or inclination to try compile it on other platforms—it extensively used APIs for which there are <em>still</em> no equivalent counterparts on other platforms, some thirteen or so years later.</p>
<p>So, if you were to try get PyParallel working on Linux or Mac OS X, for example, you’d need to write a whole bunch of thread pool and synchronization scaffolding, as well as <code>PxSocket_IoLoop()</code>-equivalents using whatever the underlying platform’s optimal socket multiplexing system call was.</p>
</section>
<section id="visual-studio-debugger" class="level5">
<h5 class="anchored" data-anchor-id="visual-studio-debugger">Visual Studio Debugger</h5>
<p>The other element of developing PyParallel on Windows that I consider crucial to its success (again, defining success as <em>getting a proof-of-concept working in about 2-3 months</em>) was Visual Studio’s sublime debugging facilities.</p>
<p>Microsoft has always invested heavily in fantastic debugger experiences. This includes usermode application debugging via tools like Visual Studio, all the way up to kernel debugging via Windbg.</p>
<p>The first week or two of PyParallel’s development was simply stepping through the Python C code line-by-line in Visual Studio’s debugger, building up a mental model of exactly how the interpreter worked at the lowest-level when executing a Python program. I didn’t write a line of code during this initial exploratory period—I was genuinely just traipsing through the debugger observing how Python <em>worked</em> and building up my situational awareness and mental model. Incredibly valuable experience, by the way. It’s my favorite way of getting up to speed with an unfamiliar code base.</p>
<p>Visual Studio Code is pretty good at debugging C programs visually these days on non-Windows platforms—I certainly used it a lot at Voltron on our Theseus product, which was exclusively in Linux and C++. However, Visual Studio Code didn’t appear until 2015, whereas my initial PyParallel hacking was toward the end of 2012.</p>
<p>Once I started actually writing code for PyParallel, again, the Visual Studio debugger was indispensable. Particularly due to how frequently I’d be crashing in the course of normal development, heh. It was incredibly handy with a few mouse clicks to be able to freeze all threads OTHER than the one you were interested in, step execution through that, then resume, etc. You can do all of this via <code>gdb</code> and <code>lldb</code> when doing console debugging on UNIX-ish platforms, but it’s definitely not as convenient as a full-featured IDE for debugging.</p>
</section>
</section>
</section>
<section id="performance" class="level3">
<h3 class="anchored" data-anchor-id="performance">Performance</h3>
<p>Now, for all its limitations and ultimate market failure, PyParallel excelled at the one thing it was designed to do well: async I/O-oriented TCP/IP servers, where users would implement protocol classes that featured <em>completion-oriented</em> callbacks, and those callbacks could be run simultaneously on multiple cores without any egregious slowdown (i.e.&nbsp;compared to normal, single-threaded Python code); i.e.: in parallel.</p>
<p>There was negligible overhead introduced by instrumenting all of the thread-sensitive macros, nor the thread-safe alternates for reference counting (don’t do it), garbage collection (don’t do it), memory allocation (simple block allocator), and memory reclamation (reset block allocator after a callback has completed). Collectively, this all ensured that the new parallel context Python code ran just as fast, if not faster, than normal single-threaded Python code.</p>
<p>Remember, the prior approach by Greg Stein (some sixteen years prior) where fine-grained locking was introduced at the individual object level made <strong>all</strong> Python code run about 40% slower, not just new multi-threaded code.</p>
<p>So PyParallel at least demonstrated that you could get a mostly-functional parallel version of Python without incurring prohibitive slowdown to all code.</p>
<p>The PyParallel <a href="https://pyparallel.org/#performance">Performance</a> section of the website features some concrete metrics that I captured back in 2015 with whatever hardware I had lying around at the time.</p>
<p>My favorite metric was that PyParallel’s plaintext benchmark (basically a HTTP server that responded to <code>/plaintext</code> with a plain text <code>Hello, World!</code> response) performance yielded 132,772 requests per second which put it into first place across all the platforms I benchmarked.</p>
<p>LWAN, a raw C Linux implementation well-known for its performance, came in second with 128,126 requests per second. Granted, I cheated on my side, leveraging an SSE-accelerated HTTP parser to process the incoming request, per the <code>http11 = True</code> line below:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PyParallel (Fast)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (Uses picohttpparser's SSE-accelerated HTTP parser.)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="cf">async</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Plaintext:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    http11 <span class="op">=</span> <span class="va">True</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plaintext(<span class="va">self</span>, transport, data):</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">b'Hello, World!'</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>server <span class="op">=</span> <span class="cf">async</span>.server(<span class="st">'0.0.0.0'</span>, <span class="dv">8080</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span>.register(transport<span class="op">=</span>server, protocol<span class="op">=</span>Plaintext)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span>.run()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So the only Python code actually being executed in this example was the <code>return b'Hello, World!'</code> line, which is so simple its basically a no-op. Thus, the only thing I was really demonstrating there was the performance of the <code>PxSocket_IoLoop()</code> implementation, plus the underlying Windows threadpool and async I/O facilities.</p>
<p>The <em>slow</em> version featured a full HTTP request parser written in Python, which clocked in at 53,455 requests per second (which was still significantly higher than other pure-Python implementations like Tornado).</p>
</section>
<section id="more-information" class="level3">
<h3 class="anchored" data-anchor-id="more-information">More Information</h3>
<p>I’ve omitted a lot of PyParallel details on purpose—this section is long enough as it is! If you’re interested in learning more, I’d recommend the following deck which I presented at PyData 2013 in New York City:</p>
<div>
<script async="" class="speakerdeck-embed" data-id="606aa4e02d30013103c12a5f68b843a3" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>
</div>
<p>Additionally, all the source code for PyParallel is available on <a href="https://github.com/pyparallel/pyparallel">Github</a>, and the landing page’s <code>README.md</code> has additional technical information about the project and implementation. You can download a working, usable installer, complete with PyParallel-compatible versions of Cython, NumPy, and PyODBC, and various other third-party <a href="https://github.com/pyparallel/pyparallel/tree/branches/3.3-px/Lib/site-packages">site-packages</a> from the <a href="https://github.com/pyparallel/pyparallel/releases/tag/3.3.5.99805">PyParallel 3.3.5.99805 Release</a> page.</p>
</section>
</section>
</section>
<section id="python-free-threading" class="level1">
<h1>Python Free-Threading</h1>
<p>So far we’ve covered Greg Stein’s initial attempts at removing the GIL back in 1996, plus my attempts at removing the GIL limitations without actually removing the GIL via PyParallel around 2012-2013. I’ve introduced four main categories of things that need to be tackled when attempting to solve the parallel Python problem:</p>
<ol type="1">
<li>Reference counting.</li>
<li>Garbage collection.</li>
<li>Memory allocation.</li>
<li>Memory reclamation.</li>
</ol>
<p>Funnily enough, the <a href="https://peps.python.org/pep-0703/#overview-of-cpython-changes">Overview of CPython Changes</a> section in PEP-703 also lists four categories, albeit slightly different:</p>
<blockquote class="blockquote">
<p>The implementation changes can be grouped into the following four categories:</p>
<ul>
<li>Reference counting <em>(and garbage collection)</em></li>
<li>Memory management</li>
<li>Container thread-safety</li>
<li>Locking and atomic APIs</li>
</ul>
</blockquote>
<p>I didn’t spend time discussing how <em>Container thread-safety</em> was tackled by Greg in his work, nor how I tackled it in my PyParallel work. Here’s a quick recap: Greg used a single global mutex to protect container objects (i.e. lists, dicts), and I did all kinds of hacky type interception that required you to explicitly <em>“protect”</em> a global or non-local <code>list</code> or <code>dict</code> object via <code>async.protect(obj)</code>. Greg’s approach was slow but correct, my approach was fast but kinda’ sucked, and would crash the Python interpreter if you didn’t use it properly. Thankfully, the requisite engineering elbow-grease was applied for the free-threading work and a fast <em>and</em> correct solution (that doesn’t kinda’ suck) was obtained.</p>
<p><a href="https://peps.python.org/pep-0703/">PEP-703</a> goes into great detail on all aspects of the free-threaded implementation, from motivation to very detailed descriptions of the implementation. I highly recommend reading it if you’ve gotten this far so you can see how all the obstacles I’ve been discussing were overcome.</p>
<p>I’ll spend a little bit of time in this next section covering some of the key points of the free-threading implementation, particularly as it pertains to the things that were done differently to Greg Stein’s work and PyParallel regarding reference counting, garbage collection, memory, etc.</p>
<p>After that, we’ll take a look at some non-trivial examples of real-world problems that can now be tackled performantly.</p>
<section id="implementation-1" class="level2">
<h2 class="anchored" data-anchor-id="implementation-1">Implementation</h2>
<p>Much like PyParallel, the Free-Threading Python work needed to augment the standard <code>PyObject</code> structure in order to support the new thread-safe functionality in lieu of the traditional single Global Interpreter Lock.</p>
<p>Let’s review these changes first, focusing solely on 64-bit Python builds.</p>
<section id="changes-to-pyobject-1" class="level3">
<h3 class="anchored" data-anchor-id="changes-to-pyobject-1">Changes to PyObject</h3>
<section id="python-3.13-pyobject" class="level4">
<h4 class="anchored" data-anchor-id="python-3.13-pyobject">Python 3.13 PyObject</h4>
<p>The standard Python 3.13 <code>PyObject</code> struct is semantically identical to the one we introduced earlier in the Python 1.4 <a href="#objects-and-varobjects">Objects and VarObjects</a> section (albeit with types tweaked to support 64-bit architectures):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> __int64 Py_ssize_t<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    Py_ssize_t ob_refcnt<span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    PyTypeObject <span class="op">*</span>ob_type<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyObject<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    PyObject ob_base<span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    Py_ssize_t ob_size<span class="op">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyVarObject<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-simple callout-note no-icon callout-titled" title="Actual C Header Code">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Actual C Header Code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <em>actual</em> C header code used to define the <code>PyObject</code> structure in Python 3.13 is much more verbose these days. It can be found in <a href="https://github.com/python/cpython/blob/v3.13.1/Include/object.h#L163">Include/object.h</a> and looks like this:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> _object <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#if (defined(__GNUC__) || defined(__clang__)) </span><span class="op">\</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="pp">        &amp;&amp; !(defined __STDC_VERSION__ &amp;&amp; __STDC_VERSION__ &gt;= 201112L)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// On C99 and older, anonymous union is a GCC and clang extension</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    __extension__</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef _MSC_VER</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ignore MSC warning C4201: "nonstandard extension used:</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// nameless struct/union"</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    __pragma<span class="op">(</span>warning<span class="op">(</span>push<span class="op">))</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    __pragma<span class="op">(</span>warning<span class="op">(</span>disable<span class="op">:</span> <span class="dv">4201</span><span class="op">))</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>       Py_ssize_t ob_refcnt<span class="op">;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#if SIZEOF_VOID_P &gt; 4</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>       PY_UINT32_T ob_refcnt_split<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef _MSC_VER</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    __pragma<span class="op">(</span>warning<span class="op">(</span>pop<span class="op">))</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    PyTypeObject <span class="op">*</span>ob_type<span class="op">;</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    PyObject ob_base<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    Py_ssize_t ob_size<span class="op">;</span> <span class="co">/* Number of items in variable part */</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyVarObject<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>PyVarObject</code> remains simple, as can be seen.</p>
</div>
</div>
</div>
<p>The visual depiction of <code>PyObject</code> in Python 3.13 64-bit is the same as before, with a total structure size of 16 bytes:</p>
<div class="struct-layout">
<div class="struct-cell py-field" style="grid-column: span 8;">
<pre>Py_ssize_t ob_refcnt
(8 bytes)</pre>
</div>
<div class="struct-cell py-field" style="grid-column: span 8;">
<pre>PyTypeObject *ob_type
(8 bytes)</pre>
</div>
</div>
</section>
<section id="free-threaded-pyobject" class="level4">
<h4 class="anchored" data-anchor-id="free-threaded-pyobject">Free-Threaded PyObject</h4>
<p>The new <code>PyObject</code> structure in the Free-Threaded build has grown numerous new fields, and lives below the GIL version in <a href="https://github.com/python/cpython/blob/v3.13.1/Include/object.h#L207">Include/object.h</a>, reproduced below (with supporting typedefs):</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Only the two least significant bits are used; remaining bits</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">// always zero.</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 0b00: unlocked</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">// 0b01: locked</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 0b10: unlocked and has parked threads</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">// 0b11: locked and has parked threads</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> _bits<span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyMutex<span class="op">;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ob_tid stores the thread id (or zero). It is also used</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// by the GC and the trashcan mechanism as a linked list</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// pointer and by the GC to store the computed "gc_refs"</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// refcount.</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uintptr_t</span> ob_tid<span class="op">;</span>           <span class="co">// thread id</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> _padding<span class="op">;</span>          <span class="co">// ob_flags in 3.14+</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    PyMutex ob_mutex<span class="op">;</span>           <span class="co">// per-object lock</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> ob_gc_bits<span class="op">;</span>         <span class="co">// gc-related state</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> ob_ref_local<span class="op">;</span>      <span class="co">// local reference count</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    Py_ssize_t ob_ref_shared<span class="op">;</span>   <span class="co">// shared (atomic) reference count</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    PyTypeObject <span class="op">*</span>ob_type<span class="op">;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PyObject<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>N.B. The <code>_padding</code> field has been renamed to <code>ob_flags</code> in Python 3.14+.</p>
<p>A visual depiction of the Free-Threaded PyObject structure on 64-bit architectures follows. The object size has grown an additional 16 bytes from the with-GIL <code>PyObject</code>, doubling the total structure size to 32 bytes.</p>
<div class="struct-layout">
<div class="struct-cell ft-field" style="grid-column: span 8;">
<pre>uintptr_t ob_tid
(8 bytes)</pre>
</div>
<div class="struct-cell ft-field" style="grid-column: span 2;">
<pre>uint16_t
ob_flags
(2 bytes)</pre>
</div>
<div class="struct-cell ft-field" style="grid-column: span 1;">
<pre>PyMutex
ob_mutex
(1 byte)</pre>
</div>
<div class="struct-cell ft-field" style="grid-column: span 1;">
<pre>uint8_t
ob_gc_bits
(1 byte)</pre>
</div>
<div class="struct-cell ft-field" style="grid-column: span 4;">
<pre>uint32_t
ob_ref_local
(4 bytes)</pre>
</div>
<div class="struct-cell ft-field" style="grid-column: span 8;">
<pre>Py_ssize_t ob_ref_shared
(8 bytes)</pre>
</div>
<div class="struct-cell py-field" style="grid-column: span 8;">
<pre>PyTypeObject *ob_type
(8 bytes)</pre>
</div>
</div>
<p>If you’ve followed along with the prior work exposition earlier in the article, you can probably take a pretty educated guess as to not only what the new fields are for, but also, why they were needed.</p>
<section id="object-thread-id-uintptr_t-ob_tid" class="level5">
<h5 class="anchored" data-anchor-id="object-thread-id-uintptr_t-ob_tid">Object Thread ID: <code>uintptr_t ob_tid</code></h5>
<p>This field captures the thread ID of the owning thread for any given object. I like this! I also like how this particular value is obtained, because it means you can quickly check if <em>you</em> own the thread by comparing an object’s thread ID with your own, as follows:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">uintptr_t</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>_Py_ThreadId<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uintptr_t</span> tid<span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> __readgsqword<span class="op">(</span><span class="dv">48</span><span class="op">);</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tid<span class="op">;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">int</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>_Py_IsOwnedByCurrentThread<span class="op">(</span>PyObject <span class="op">*</span>ob<span class="op">)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ob<span class="op">-&gt;</span>ob_tid <span class="op">==</span> _Py_ThreadId<span class="op">();</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Hey! Look at that, it uses the same technique PyParallel used to determine the current thread ID with the least amount of overhead possible. I’m not sure if the idea was sourced from PyParallel or not; if not, it’s at least a good example of <a href="https://en.wikipedia.org/wiki/Convergent_evolution">convergent evolution</a>—that is, if you need to quickly determine the ID of the current thread, well, there’s really only one optimal way of doing it per platform.</p>
<div class="callout callout-style-simple callout-note no-icon callout-titled" title="Actual C Header Code">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Actual C Header Code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>As usual, the actual C code is much more… flowery; the relevant <a href="https://github.com/python/cpython/blob/v3.14.0a4/Include/object.h#L183-L257">Include/object.h</a> is reproduced below:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">uintptr_t</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>_Py_ThreadId<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uintptr_t</span> tid<span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined(_MSC_VER) &amp;&amp; defined(_M_X64)</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> __readgsqword<span class="op">(</span><span class="dv">48</span><span class="op">);</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(_MSC_VER) &amp;&amp; defined(_M_IX86)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> __readfsdword<span class="op">(</span><span class="dv">24</span><span class="op">);</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(_MSC_VER) &amp;&amp; defined(_M_ARM64)</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> __getReg<span class="op">(</span><span class="dv">18</span><span class="op">);</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__MINGW32__) &amp;&amp; defined(_M_X64)</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> __readgsqword<span class="op">(</span><span class="dv">48</span><span class="op">);</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__MINGW32__) &amp;&amp; defined(_M_IX86)</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> __readfsdword<span class="op">(</span><span class="dv">24</span><span class="op">);</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__MINGW32__) &amp;&amp; defined(_M_ARM64)</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> __getReg<span class="op">(</span><span class="dv">18</span><span class="op">);</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__i386__)</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    __asm__<span class="op">(</span><span class="st">"movl </span><span class="sc">%%</span><span class="st">gs:0, %0"</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tid<span class="op">));</span>  <span class="co">// 32-bit always uses GS</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__MACH__) &amp;&amp; defined(__x86_64__)</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    __asm__<span class="op">(</span><span class="st">"movq </span><span class="sc">%%</span><span class="st">gs:0, %0"</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tid<span class="op">));</span>  <span class="co">// x86_64 macOSX uses GS</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__x86_64__)</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>   __asm__<span class="op">(</span><span class="st">"movq </span><span class="sc">%%</span><span class="st">fs:0, %0"</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tid<span class="op">));</span>  <span class="co">// x86_64 Linux, BSD uses FS</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__arm__) &amp;&amp; __ARM_ARCH &gt;= 7</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    __asm__ <span class="op">(</span><span class="st">"mrc p15, 0, %0, c13, c0, 3</span><span class="sc">\n</span><span class="st">bic %0, %0, #3"</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tid<span class="op">));</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__aarch64__) &amp;&amp; defined(__APPLE__)</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    __asm__ <span class="op">(</span><span class="st">"mrs %0, tpidrro_el0"</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tid<span class="op">));</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__aarch64__)</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    __asm__ <span class="op">(</span><span class="st">"mrs %0, tpidr_el0"</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tid<span class="op">));</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__powerpc64__)</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#if defined(__clang__) &amp;&amp; _Py__has_builtin(__builtin_thread_pointer)</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> <span class="op">(</span><span class="dt">uintptr_t</span><span class="op">)</span>__builtin_thread_pointer<span class="op">();</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#else</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// r13 is reserved for use as system thread ID by the Power 64-bit ABI.</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">register</span> <span class="dt">uintptr_t</span> tp __asm__ <span class="op">(</span><span class="st">"r13"</span><span class="op">);</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    __asm__<span class="op">(</span><span class="st">""</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tp<span class="op">));</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> tp<span class="op">;</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#endif</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__powerpc__)</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#if defined(__clang__) &amp;&amp; _Py__has_builtin(__builtin_thread_pointer)</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> <span class="op">(</span><span class="dt">uintptr_t</span><span class="op">)</span>__builtin_thread_pointer<span class="op">();</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#else</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// r2 is reserved for use as system thread ID by the Power 32-bit ABI.</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">register</span> <span class="dt">uintptr_t</span> tp __asm__ <span class="op">(</span><span class="st">"r2"</span><span class="op">);</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    __asm__ <span class="op">(</span><span class="st">""</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tp<span class="op">));</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> tp<span class="op">;</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#endif</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__s390__) &amp;&amp; defined(__GNUC__)</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Both GCC and Clang have supported __builtin_thread_pointer</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// for s390 from long time ago.</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> <span class="op">(</span><span class="dt">uintptr_t</span><span class="op">)</span>__builtin_thread_pointer<span class="op">();</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="pp">#elif defined(__riscv)</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#if defined(__clang__) &amp;&amp; _Py__has_builtin(__builtin_thread_pointer)</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> <span class="op">(</span><span class="dt">uintptr_t</span><span class="op">)</span>__builtin_thread_pointer<span class="op">();</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#else</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// tp is Thread Pointer provided by the RISC-V ABI.</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    __asm__ <span class="op">(</span><span class="st">"mv %0, tp"</span> <span class="op">:</span> <span class="st">"=r"</span> <span class="op">(</span>tid<span class="op">));</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#endif</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback to a portable implementation if we do not have a faster</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// platform-specific implementation.</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    tid <span class="op">=</span> _Py_GetThreadLocal_Addr<span class="op">();</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> tid<span class="op">;</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> Py_ALWAYS_INLINE <span class="dt">int</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>_Py_IsOwnedByCurrentThread<span class="op">(</span>PyObject <span class="op">*</span>ob<span class="op">)</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef _Py_THREAD_SANITIZER</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _Py_atomic_load_uintptr_relaxed<span class="op">(&amp;</span>ob<span class="op">-&gt;</span>ob_tid<span class="op">)</span> <span class="op">==</span> _Py_ThreadId<span class="op">();</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ob<span class="op">-&gt;</span>ob_tid <span class="op">==</span> _Py_ThreadId<span class="op">();</span></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="reference-counts-ob_ref_local-and-ob_ref_shared" class="level5">
<h5 class="anchored" data-anchor-id="reference-counts-ob_ref_local-and-ob_ref_shared">Reference Counts: <code>ob_ref_local</code> and <code>ob_ref_shared</code></h5>
<p>TODO: Biased and deferred reference counting. Optimization if attempting to incref/decref an object we own.</p>
</section>
<section id="per-object-locking-pymutex-ob_mutex" class="level5">
<h5 class="anchored" data-anchor-id="per-object-locking-pymutex-ob_mutex">Per-Object Locking: <code>PyMutex ob_mutex</code></h5>
<p>TBD</p>
</section>
<section id="garbage-collection-state-ob_gc_bits" class="level5">
<h5 class="anchored" data-anchor-id="garbage-collection-state-ob_gc_bits">Garbage Collection State: <code>ob_gc_bits</code></h5>
</section>
</section>
</section>
</section>
</section>
<section id="parallelopedia" class="level1">
<h1>Parallelopedia</h1>
<section id="http-server" class="level2">
<h2 class="anchored" data-anchor-id="http-server">HTTP Server</h2>
<ul>
<li>Multi-threaded <code>asyncio</code>-based HTTP server.</li>
<li>Performance/benchmarks.</li>
<li>Compare <code>-Xgil=0</code> to with GIL.</li>
</ul>
<p>TODO</p>
</section>
<section id="wiki-server" class="level2">
<h2 class="anchored" data-anchor-id="wiki-server">Wiki Server</h2>
<p>TODO</p>
</section>
</section>
<section id="pytorch-and-free-threading" class="level1">
<h1>PyTorch and Free-Threading</h1>
<section id="training-a-local-gpt2" class="level2">
<h2 class="anchored" data-anchor-id="training-a-local-gpt2">Training a local GPT2</h2>
</section>
<section id="multi-threaded-inference" class="level2">
<h2 class="anchored" data-anchor-id="multi-threaded-inference">Multi-threaded Inference</h2>
<ul>
<li>Via <code>asyncio</code> &amp; HTTP server.</li>
</ul>
</section>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="pyparallel-backstory" class="level2">
<h2 class="anchored" data-anchor-id="pyparallel-backstory">PyParallel Backstory</h2>
<p>I’m not sure how interesting this section will be to readers, which is why I’ve stashed it at the end of the article. The older I get—especially now that I have a daughter—the more cathartic it is reminiscing about the early parts of my career some nearly-two-decades-ago.</p>
<p>This section captures the backstory behind PyParallel. PyParallel was born out of a) my interest in asynchronous I/O and multithreaded programming, and b) my experience with Snakebite, an “open source network” I built with the goal to provide Python committer’s access to all the different types of platforms Python ran on—especially all the UNIX derivatives from the late 90s to 00s for which I seemed to be genetically predisposed to overly romanticize.</p>
<p>And I came up with the idea for Snakebite as a Python committer, where I found myself often frustrated at trying to debug buildbot breaks on platforms for which I had no access. And becoming a Python committer was an artifact of my involvement with the Python language, particularly with regards to providing buildbots and help with Windows 64-bit Python builds in the early days where AMD64 was still a novelty.</p>
<p>And I was led to Python by a random article by Eric S. Raymond, coupled with growing resentment toward Perl, which I found myself having to use when working with ClearQuest.</p>
<p>That’s the reverse chronological history in a nutshell. The next few sections go into more detail chronologically.</p>
<section id="becoming-a-python-committer" class="level3">
<h3 class="anchored" data-anchor-id="becoming-a-python-committer">Becoming a Python Committer</h3>
<p>From around 2000 to 2004, I was writing mostly C, C++, and Perl. I had founded a company with a business partner, Jamie Echlin, called <a href="https://web.archive.org/web/20080704070902/http://www.onresolve.com/home/">OnResolve</a>, and provided consultancy for an IBM—formerly Rational—change management product called <a href="https://www.ibm.com/products/rational-clearquest">ClearQuest</a>, as well as a number of software products that extended the functionality of ClearQuest. ClearQuest could be customized in two languages: Visual Basic, and Perl. The most prominent software product Jamie and I created was OnMessage, which was a combination of C++ and Perl, and provided enhanced e-mail notification facilities for ClearQuest. Jamie deserves much of the credit for what eventually became known as <a href="https://web.archive.org/web/20080622060654/http://www.onresolve.com/products/onmessage/">OnMessage</a> —despite having a quirky Perl coding style I found difficult to work with, he absolutely laid the foundation for the product and the subsequent success we had with it.</p>
<p>ClearQuest, and its version-control counterpart, ClearCase, were ubiquitous in all of the industries that had the most money in the early to mid 2000s. Particularly finance and oil. No-one liked using either of them, they were expensive, required huge teams to maintain and administer, and with the advent of tools like Git and Github (albeit many years later), they are now relegated to the annals of history.</p>
<p>I was relatively productive with Perl, but I didn’t particularly like it. And I absolutely loathed having to deal with other people’s Perl code. Around late 2004 and 2005, Python arrived on my radar. I remember reading Eric S. Raymond’s <a href="https://www.linuxjournal.com/article/3882">Why Python</a> article about Python, and it resonated strongly with me. Coming from Perl, Python just felt simply magical. It was intuitive, easy to read, not cryptic, easy to work with other people’s code, powerful–particularly as a glue language.</p>
<p>I adored it. I tackled all new projects with Python. I wrote a Python wrapper around ClearQuest named <a href="https://github.com/tpn/cqpython">cqpython</a>, which I used to carry out one of my most favorite projects to date: merging two ClearQuest databases into a single instance by auto-generating optimized SQL to conduct the merge at the database level. (This was harder than it sounds, as all ClearQuest databases would start off with the same unique ID offsets, so two otherwise unrelated databases would have almost identical keys for different entities, which needed to be resolved efficiently at merge time.)</p>
<p>By 2007-2008, I was bored of ClearQuest—it wasn’t a fun product to work with, nor did it look like it would be a good career move to continue specializing in it; the prices were extortionate, a lot of companies were trying to move off it, and better, cheaper alternatives were popping up.</p>
<p>However, it sure had been lucrative. I was able to enjoy extended periods of not needing to work, and I spent that time on things I was finding really fun, like contributing to Python. I set up a bunch of buildbots for Python, and was particularly interested in getting the 64-bit Windows Python builds “green” on the buildbots I had set up. I think I even paid for the Verisign code signing certificate used for the Python.org official Windows binaries back then (this was still the Python 2.x days).</p>
<p>This was back in the day where Martin von Löwis was still an active contributor for Python, and if I recall correctly, the release manager for the Python 2.x series. Martin also maintained the Windows Python builds, a role that was eventually taken over by Steve Dower, who is still doing it to this day.</p>
<p>In 2008, I attended PyCon in Chicago. It was my first-ever PyCon. I had a fantastic time, and particularly loved the core Python sprints that happened after the conference. For those that are unaware, this is the one time every year where many of the active Python committers, including Guido, get together in a big conference room and just hack on Python collectively for a few days.</p>
<p>It was a bit of a surreal experience, sitting in a room hacking on Python alongside the very founder of Python himself—Guido—plus many other luminaries that actively contributed to the language over the years. I don’t know who took this photo, nor why it appears to have dimensions tailored towards ants, but you can see myself and Michael Foord in the foreground table (dark maroon t-shirt on the left and orange t-shirt on the right, respectively), Guido in the bright green shirt at the top right table, sitting with Neal Norwitz and Barry Warsaw. And that looks like Brett Canon in thinking pose in the dark t-shirt and Martin von Löwis sitting next to him scratching his head at whatever Brett was doing at the middle table :-)</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/pycon2008-chicago-core-sprints.jpg" class="img-fluid figure-img"></p>
<figcaption>PyCon 2008 Core Sprint</figcaption>
</figure>
</div>
<p>I remember inundating Martin with patch bombs fixing various buildbot-related things at the start of that sprint, to which Martin eventually dealt with by simply offering me commit privileges. I enthusiastically accepted! Honestly, that was a career highlight. This was in the days before everything was Github and Pull Requests—becoming a Python committer meant you would literally get svn+ssh access to svn.python.org, plus ssh access to the python.org boxes themselves if you wanted it/needed it (i.e.&nbsp;for buildbot master configuration). This was certainly more compelling than the ClearQuest consultancy I’d done in the past, that’s for sure!</p>
<p>As much as I love Git and Github, getting your pull request accepted for an open source project just doesn’t have the same feel as getting offered commit privileges like back in the old days.</p>
</section>
</section>
</section>
<section id="colophon" class="level1">
<h1>Colophon</h1>
<p>As much as I enjoy reading technical articles, I often find myself equally interested in the tools the author used in the production of the article. In this final section, I attempt to capture details regarding the tools used to author this article, in no particular order.</p>
<section id="quarto-markdown" class="level2">
<h2 class="anchored" data-anchor-id="quarto-markdown">Quarto &amp; Markdown</h2>
<p>This article was written in Markdown using <a href="https://quarto.org">Quarto</a>. The source code is <a href="https://github.com/tpn/website/edit/main/articles/from-pyparallel-to-python-free-threading/index.qmd">here</a>; there’s also an <em>Edit this page</em> link on the top-right of the page, under the contents (assuming you’re viewing the site on a wide-enough device).</p>
<p>For the syntax color scheme, I copied the <a href="https://github.com/quarto-dev/quarto-cli/blob/80bf6b5848bf644de3a4d59e26b5eb067375986a/src/resources/pandoc/highlight-styles/dracula.theme"><code>dracula.theme</code></a> from the Quarto repository into <a href="https://github.com/tpn/website/blob/main/tpn.theme"><code>tpn.theme</code></a> and then just hacked on it until I was mostly content with the results.</p>
<p>My whole <a href="https://trent.me">trent.me</a> website uses Quarto, and is hosted publicly on Github at my <a href="https://github.com/tpn/website">website</a> repo. I also leverage Github’s hosting facilities via their “Pages” functionality, the configuration of which can be seen below.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="Github Pages Configuration">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Github Pages Configuration
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="images/github-tpn-website-pages.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Github Pages Configuration for tpn/website"><img src="images/github-tpn-website-pages.png" class="img-fluid figure-img" alt="Github Pages Configuration for tpn/website"></a></p>
<figcaption>Github Pages Configuration for tpn/website</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>“Development” on the website (i.e.&nbsp;writing articles like this one) is done on a variety of boxes, typically all Linux/WSL2. Quarto has a useful preview feature, so my local workflow is usually just something as simple as:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> cd ~/src/website</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> quarto preview</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I edited this <code>index.qmd</code> page predominantly in vim, although I’d sometimes use VS Code and the Quarto extension with integrated previewing. I generally turn Copilot off in vim when writing pure text, it’s too distracting, and isn’t geared toward writing new prose versus coding tasks, which is obviously its bread and butter.</p>
</section>
<section id="ai-tooling" class="level2">
<h2 class="anchored" data-anchor-id="ai-tooling">AI Tooling</h2>
<p>In general, I for one welcome our new AI overlords. I have heavily integrated Copilot and ChatGPT into my workflow now as a developer for the past two years or so, and I thoroughly enjoy leveraging both tools.</p>
<section id="lm-studio" class="level3">
<h3 class="anchored" data-anchor-id="lm-studio">LM Studio</h3>
<p><a href="https://lmstudio.ai/">LM Studio</a> has also left a lasting impression and I’ve enjoyed experimenting with it a lot recently too. This has been aided by having a local box at home with 256 GB RAM, 40 cores, four Tesla V100 32GB GPUs, and a 14TB RAID0 stripe—plenty of room to download all of these huge models coming out.</p>
<p>A nice thing about LM Studio is that with a few clicks you can expose a local, OpenAI-compatible REST interface. LM Studio is powered by <a href="https://github.com/ggerganov/llama.cpp">llama.cpp</a>.</p>
</section>
<section id="aider" class="level3">
<h3 class="anchored" data-anchor-id="aider">Aider</h3>
<p>I came across <a href="https://aider.chat">Aider</a> recently. Aider is, to quote their website, directly, <em>AI pair programming in your terminal</em>. It’s pretty neat, and I played around with having it drive a little bit of the Python development in the <a href="https://github.com/tpn/parallelopedia">parallelopedia</a> repo, and a lot of the development in the <a href="https://github.com/tpn/parallelopedia-ui">parallelopedia-ui</a> repo, which is the React, Bootstrap, JavaScript/JSX web UI seen in this article.</p>
<p>i’m not a web developer, I don’t know how to write web apps, I don’t care about code quality of web apps I do write (as I’m not writing anything other than demos or small little tools), so, whatever gets the job done is fine. However, I am, by trade, a software engineer, so a lot of the core skill set still <strong>commutes</strong> when working in foreign domains. <em>Especially</em> these days when you have AI an alt-tab away, or, in the case of Aider, available in a terminal to carry out your development requests.</p>
<p>The biggest issue I had with Aider was honestly just biting the bullet and just trying it. <em>Begin, the rest is easy</em> as they say. It’s definitely not perfect–I had to jump in and fix things a few times every session I had with it, but we’re talking maybe five interventions within a 3-4 hour coding session, give or take. It was particularly good at generating scaffolding that I could hack further with a single sentence. And it was really good at writing an entire Python unit test module for me based on a single-sentence.</p>
<p>To get started with Aider:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> python <span class="at">-m</span> pip install aider-install</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> aider-install</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Restart shell, or `export PATH=$HOME/.local/bin:$PATH`</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> which aider</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">/home/trent/.local/bin/aider</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># I've got my OpenAI keys in a GPG-encrypted file ~/.zsh/openai_key.asc.</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> which init_openai_key</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">init_openai_key ()</span> <span class="kw">{</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-f</span> ~/.zsh/openai_key.asc <span class="bu">]</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">then</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">export</span> <span class="va">OPENAI_API_KEY</span><span class="op">=</span><span class="va">$(</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>            <span class="ex">gpg</span> <span class="at">-d</span> <span class="at">--batch</span> <span class="at">--quiet</span> ~/.zsh/openai_key.asc</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">)</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> init_openai_key</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> aider <span class="at">--model</span> gpt-4o <span class="at">--vim</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It was trivial to point it at a local model hosted by LM Studio, too, after enabling the <em>Developer</em> view and starting a local development server (which will default to hosting on <code>http://&lt;hostname&gt;:1234/v1</code>):</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> LM_STUDIO_API_KEY=notused <span class="dt">\</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  LM_STUDIO_API_BASE=http://<span class="va">$(</span><span class="fu">hostname</span><span class="va">)</span>:1234/v1 <span class="dt">\</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    aider <span class="at">--model</span> lm_studio/qwen2.5-coder-32b-instruct@fp16 <span class="at">--vim</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By default, Aider keeps a Markdown transcript of your sessions in a file named <code>.aider.chat.history.md</code> in the root of the repository you’re working with. I have included the transcript from my <a href="https://github.com/tpn/parallelopedia-ui">parallelopedia-ui</a> repo below. I haven’t edited it, so it contains all my mistakes and errors and whatnot.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="Aider Chat History">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Aider Chat History
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="aider-chat-started-at-2025-01-03-165315" class="level1">
<h1>aider chat started at 2025-01-03 16:53:15</h1>
<blockquote class="blockquote">
<p>Add .aider* to .gitignore (recommended)? (Y)es/(N)o [Yes]: y<br>
Added .aider* to .gitignore<br>
/home/trent/.local/bin/aider –model gpt-4o –vim<br>
Warning: gpt-4o expects these environment variables<br>
- OPENAI_API_KEY: Not set<br>
Warning: gpt-4o-mini expects these environment variables<br>
- OPENAI_API_KEY: Not set<br>
You can skip this check with –no-show-model-warnings<br>
https://aider.chat/docs/llms/warnings.html</p>
</blockquote>
</section>
<section id="aider-chat-started-at-2025-01-03-165354" class="level1">
<h1>aider chat started at 2025-01-03 16:53:54</h1>
<blockquote class="blockquote">
<p>/home/trent/.local/bin/aider –model gpt-4o –vim<br>
Aider v0.70.0<br>
Main model: gpt-4o with diff edit format<br>
Weak model: gpt-4o-mini<br>
Git repo: .git with 0 files<br>
Repo-map: using 1024 tokens, auto refresh</p>
</blockquote>
<section id="add-srcwiki.jsx" class="level4">
<h4 class="anchored" data-anchor-id="add-srcwiki.jsx">/add src/Wiki.jsx</h4>
<blockquote class="blockquote">
<p>No files matched ‘src/Wiki.jsx’. Do you want to create /mnt/raid1/trent/src/parallelopedia-ui/src/Wiki.jsx? (Y)es/(N)o [Yes]: y<br>
Added src/Wiki.jsx to the chat</p>
</blockquote>
</section>
<section id="implement-srcwiki.jsx-which-will-be-a-react-bootstrap-component-that-will-have-a-single-search-box-than-spans-the-container." class="level4">
<h4 class="anchored" data-anchor-id="implement-srcwiki.jsx-which-will-be-a-react-bootstrap-component-that-will-have-a-single-search-box-than-spans-the-container.">Implement src/Wiki.jsx, which will be a React Bootstrap component that will have a single search box than spans the container.</h4>
<p>To implement the <code>Wiki</code> component using React Bootstrap with a single search box that spans the container, we will create the component in <code>src/Wiki.jsx</code>. Here is the implementation:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">'react'</span><span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Container<span class="op">,</span> Form<span class="op">,</span> FormControl } <span class="im">from</span> <span class="st">'react-bootstrap'</span><span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Wiki <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>Container<span class="op">&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>Form<span class="op">&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;</span>FormControl</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                    type<span class="op">=</span><span class="st">"search"</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>                    placeholder<span class="op">=</span><span class="st">"Search"</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                    className<span class="op">=</span><span class="st">"me-2"</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                    aria<span class="op">-</span>label<span class="op">=</span><span class="st">"Search"</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">/&gt;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;/</span>Form<span class="op">&gt;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>Container<span class="op">&gt;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> Wiki<span class="op">;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To ensure the component works correctly, make sure you have <code>react-bootstrap</code> installed in your project. If not, you can install it using the following command:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install react-bootstrap bootstrap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Tokens: 2.4k sent, 176 received. Cost: $0.0077 message, $0.0077 session.<br>
Committing src/Wiki.jsx before applying edits.<br>
Commit c522407 feat: Add Wiki component to the source directory<br>
Applied edit to src/Wiki.jsx<br>
Commit 6ce6206 feat: Implement Wiki component with search box using React Bootstrap<br>
npm install react-bootstrap bootstrap<br>
Run shell command? (Y)es/(N)o/(D)on’t ask again [Yes]: n<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="add-to-the-appropriate-in-app.jsx." class="level4">
<h4 class="anchored" data-anchor-id="add-to-the-appropriate-in-app.jsx.">Add <wiki> to the appropriate <tab> in App.jsx.</tab></wiki></h4>
<p>Please add <code>App.jsx</code> to the chat so I can make the necessary changes to include the <code>&lt;Wiki /&gt;</code> component in the appropriate <code>&lt;Tab&gt;</code>.</p>
<blockquote class="blockquote">
<p>Tokens: 2.8k sent, 31 received. Cost: $0.0072 message, $0.01 session.</p>
</blockquote>
</section>
<section id="add-srcapp.jsx-srcstats.jsx-srcterminaltab.jsx-srcterminalcomponent.jsx" class="level4">
<h4 class="anchored" data-anchor-id="add-srcapp.jsx-srcstats.jsx-srcterminaltab.jsx-srcterminalcomponent.jsx">/add src/App.jsx src/Stats.jsx src/TerminalTab.jsx src/TerminalComponent.jsx</h4>
<blockquote class="blockquote">
<p>Added src/App.jsx to the chat<br>
Added src/Stats.jsx to the chat<br>
Added src/TerminalComponent.jsx to the chat<br>
Added src/TerminalTab.jsx to the chat</p>
</blockquote>
</section>
<section id="add-srcindex.css-srcapp.scss-srcapp.css" class="level4">
<h4 class="anchored" data-anchor-id="add-srcindex.css-srcapp.scss-srcapp.css">/add src/index.css src/App.scss src/App.css</h4>
<blockquote class="blockquote">
<p>Added src/App.css to the chat<br>
Added src/App.scss to the chat<br>
Added src/index.css to the chat</p>
</blockquote>
</section>
<section id="add-to-the-appropriate-in-app.jsx.-1" class="level4">
<h4 class="anchored" data-anchor-id="add-to-the-appropriate-in-app.jsx.-1">Add <wiki> to the appropriate <tab> in App.jsx.</tab></wiki></h4>
<p>To add the <code>&lt;Wiki /&gt;</code> component to the appropriate <code>&lt;Tab&gt;</code> in <code>App.jsx</code>, we need to import the <code>Wiki</code> component and include it in the “Wiki” tab. Here are the changes:</p>
<p>src/App.jsx</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">"bootstrap/dist/css/bootstrap.min.css"</span><span class="op">;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Wiki <span class="im">from</span> <span class="st">"./Wiki"</span><span class="op">;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">"bootstrap/dist/css/bootstrap.min.css"</span><span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/App.jsx</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>Tab title<span class="op">=</span><span class="st">"Wiki"</span> eventKey<span class="op">=</span><span class="st">"wiki"</span><span class="op">&gt;&lt;/</span>Tab<span class="op">&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>Tab title<span class="op">=</span><span class="st">"Wiki"</span> eventKey<span class="op">=</span><span class="st">"wiki"</span><span class="op">&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>Wiki <span class="op">/&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;/</span>Tab<span class="op">&gt;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will ensure that the <code>Wiki</code> component is rendered within the “Wiki” tab.</p>
<blockquote class="blockquote">
<p>Tokens: 4.9k sent, 151 received. Cost: $0.01 message, $0.03 session.<br>
Committing src/App.jsx before applying edits.<br>
Commit 1682fa5 feat: Add main application component in App.jsx<br>
Applied edit to src/App.jsx<br>
Commit ce5f9ab feat: Add <wiki> component to the Wiki tab in App.jsx<br>
You can use /undo to undo and discard each aider commit.</wiki></p>
</blockquote>
</section>
<section id="voice" class="level4">
<h4 class="anchored" data-anchor-id="voice">/voice</h4>
</section>
<section id="the-wiki-search-box-doesnt-have-enough-vertical-space-between-it-and-the-tab-above.-add-some-stylesheets-or-styles-in-the-app.scss-file-to-improve-the-spacing." class="level4">
<h4 class="anchored" data-anchor-id="the-wiki-search-box-doesnt-have-enough-vertical-space-between-it-and-the-tab-above.-add-some-stylesheets-or-styles-in-the-app.scss-file-to-improve-the-spacing.">The wiki search box doesn’t have enough vertical space between it and the tab above. Add some stylesheets or styles in the app.scss file to improve the spacing.</h4>
<p>To improve the vertical spacing between the search box and the tab above it, we can add some custom styles in the <code>App.scss</code> file. Here’s how you can do it:</p>
<p>src/App.scss</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode scss code-with-copy"><code class="sourceCode scss"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>&lt;&lt;&lt;&lt;&lt;&lt;&lt; SEARCH</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Override specific elements with monospace font sizes</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>code<span class="op">,</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>kbd<span class="op">,</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>samp {</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">white-space</span>: <span class="dv">nowrap</span><span class="op">;</span> <span class="co">// Prevents text wrapping</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-size</span>: <span class="va">$font-size-monospace</span><span class="op">;</span> <span class="co">// Apply custom font size to monospace elements</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>=======</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> {</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">margin-top</span>: <span class="dv">20</span><span class="dt">px</span><span class="op">;</span> <span class="co">// Add vertical space between the tab and the search box</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Override specific elements with monospace font sizes</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>code<span class="op">,</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>kbd<span class="op">,</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>samp {</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">white-space</span>: <span class="dv">nowrap</span><span class="op">;</span> <span class="co">// Prevents text wrapping</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-size</span>: <span class="va">$font-size-monospace</span><span class="op">;</span> <span class="co">// Apply custom font size to monospace elements</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, apply this new class to the <code>Container</code> in the <code>Wiki</code> component:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>Container<span class="op">&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>Container className<span class="op">=</span><span class="st">"wiki-search-container"</span><span class="op">&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will add vertical space between the tab and the search box in the <code>Wiki</code> component.</p>
<blockquote class="blockquote">
<p>Tokens: 5.2k sent, 245 received. Cost: $0.02 message, $0.04 session.<br>
Committing src/App.scss before applying edits.<br>
Commit 065db7a feat: Add main stylesheet for the application<br>
Applied edit to src/Wiki.jsx<br>
Applied edit to src/App.scss<br>
Commit ad6f1b5 style: Add vertical spacing between the tab and search box in Wiki component<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="voice-1" class="level4">
<h4 class="anchored" data-anchor-id="voice-1">/voice</h4>
</section>
<section id="when-i-type-into-the-search-box-i-get-the-following-error-in-the-browser-console-dgx1-access-to-fetch-at-httplocalhost4444offsetspytho-from-origin-httpdgx3000-has-been-blocked-by-cors-policy-no-access-control-allow-origin-header-is-present-on-the-requested-resource.-if-an-opaque-response-serves-your-needs-set-the-requests-mode-to-no-cors-to-fetch-the-resource-with-cors-disabled." class="level4">
<h4 class="anchored" data-anchor-id="when-i-type-into-the-search-box-i-get-the-following-error-in-the-browser-console-dgx1-access-to-fetch-at-httplocalhost4444offsetspytho-from-origin-httpdgx3000-has-been-blocked-by-cors-policy-no-access-control-allow-origin-header-is-present-on-the-requested-resource.-if-an-opaque-response-serves-your-needs-set-the-requests-mode-to-no-cors-to-fetch-the-resource-with-cors-disabled.">When I type into the search box, I get the following error in the browser console: dgx/:1 Access to fetch at ‘http://localhost:4444/offsets/Pytho’ from origin ‘http://dgx:3000’ has been blocked by CORS policy: No ‘Access-Control-Allow-Origin’ header is present on the requested resource. If an opaque response serves your needs, set the request’s mode to ‘no-cors’ to fetch the resource with CORS disabled.</h4>
<blockquote class="blockquote">
<p>http://dgx:3000<br>
Add URL to the chat? (Y)es/(N)o/(A)ll/(S)kip all/(D)on’t ask again [Yes]: n<br>
http://localhost:4444/offsets/Pytho<br>
Add URL to the chat? (Y)es/(N)o/(A)ll/(S)kip all/(D)on’t ask again [Yes]: n</p>
</blockquote>
<p>The error you’re encountering is due to the CORS (Cross-Origin Resource Sharing) policy, which restricts web pages from making requests to a different domain than the one that served the web page. To resolve this issue, you can modify the fetch request to include the <code>mode: 'cors'</code> option. However, this alone might not solve the problem if the server at <code>http://localhost:4444</code> is not configured to allow requests from your origin.</p>
<p>Here’s how you can modify the fetch request in <code>src/Wiki.jsx</code>:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://localhost:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://localhost:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>          <span class="dt">mode</span><span class="op">:</span> <span class="st">'cors'</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If the server is under your control, you will need to configure it to include the <code>Access-Control-Allow-Origin</code> header in its responses. If you don’t have control over the server, you might need to use a proxy or contact the server administrator to enable CORS for your domain.</p>
<blockquote class="blockquote">
<p>Tokens: 6.0k sent, 231 received. Cost: $0.02 message, $0.06 session.<br>
Committing src/Wiki.jsx before applying edits.<br>
Commit 943c680 feat: Implement search functionality with results display in Wiki component<br>
Applied edit to src/Wiki.jsx<br>
Commit 6d699ab fix: Add CORS mode to fetch request in Wiki component<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="ask-tell-me-more-about-access-control-allow-origin-i-presume-i-need-to-have-that-set-on-the-localhost4444-server-i-do-have-control-over-it-so-is-it-just-a-matter-of-adding-that-header-to-the-servers-output" class="level4">
<h4 class="anchored" data-anchor-id="ask-tell-me-more-about-access-control-allow-origin-i-presume-i-need-to-have-that-set-on-the-localhost4444-server-i-do-have-control-over-it-so-is-it-just-a-matter-of-adding-that-header-to-the-servers-output">/ask Tell me more about Access-Control-Allow-Origin… I presume I need to have that set on the <code>localhost:4444</code> server? I do have control over it so is it just a matter of adding that header to the server’s output?</h4>
</section>
<section id="tell-me-more-about-access-control-allow-origin-i-presume-i-need-to-have-that-set-on-the-localhost4444-server-i-do-have-control-over-it-so-is-it-just-a-matter-of-adding-that-header-to-the-servers-output" class="level4">
<h4 class="anchored" data-anchor-id="tell-me-more-about-access-control-allow-origin-i-presume-i-need-to-have-that-set-on-the-localhost4444-server-i-do-have-control-over-it-so-is-it-just-a-matter-of-adding-that-header-to-the-servers-output">Tell me more about Access-Control-Allow-Origin… I presume I need to have that set on the <code>localhost:4444</code> server? I do have control over it so is it just a matter of adding that header to the server’s output?</h4>
<p>Yes, you are correct. The <code>Access-Control-Allow-Origin</code> header is a part of the CORS (Cross-Origin Resource Sharing) mechanism that allows servers to specify which origins are permitted to access their resources. When a web application makes a request to a server that is on a different origin (domain, protocol, or port), the server must include this header in its response to allow the request.</p>
<p>To resolve the CORS issue you’re facing, you need to configure your server running on <code>localhost:4444</code> to include the <code>Access-Control-Allow-Origin</code> header in its responses. Here’s how you can do it, depending on the server technology you’re using:</p>
</section>
<section id="for-express.js-node.js" class="level3">
<h3 class="anchored" data-anchor-id="for-express.js-node.js">For Express.js (Node.js)</h3>
<p>If you’re using Express.js, you can use the <code>cors</code> middleware to handle this:</p>
<ol type="1">
<li><p>Install the <code>cors</code> package:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install cors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Use the <code>cors</code> middleware in your server setup:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">'express'</span>)<span class="op">;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cors <span class="op">=</span> <span class="pp">require</span>(<span class="st">'cors'</span>)<span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>())<span class="op">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Your routes here</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(<span class="dv">4444</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Server is running on port 4444'</span>)<span class="op">;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="for-other-server-technologies" class="level3">
<h3 class="anchored" data-anchor-id="for-other-server-technologies">For Other Server Technologies</h3>
<ul>
<li><p><strong>Apache</strong>: You can add the following line to your <code>.htaccess</code> file or your server configuration:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode apache code-with-copy"><code class="sourceCode apache"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>Header<span class="st"> set Access-Control-Allow-Origin "*"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Nginx</strong>: Add the following line to your server block configuration:</p>
<pre class="nginx"><code>add_header 'Access-Control-Allow-Origin' '*';</code></pre></li>
</ul>
</section>
<section id="important-note" class="level3">
<h3 class="anchored" data-anchor-id="important-note">Important Note</h3>
<ul>
<li><p>The <code>*</code> wildcard allows any origin to access the resource. This is suitable for development but not recommended for production environments due to security concerns. In production, you should specify the exact origin(s) that are allowed to access your server.</p></li>
<li><p>If your server needs to handle credentials (such as cookies or HTTP authentication), you should set <code>Access-Control-Allow-Origin</code> to a specific origin and also include the <code>Access-Control-Allow-Credentials</code> header set to <code>true</code>.</p></li>
</ul>
<p>By adding the <code>Access-Control-Allow-Origin</code> header to your server’s responses, you should be able to resolve the CORS issue and allow your React application to make requests to the server.</p>
<blockquote class="blockquote">
<p>Tokens: 4.2k sent, 473 received. Cost: $0.02 message, $0.08 session.</p>
</blockquote>
<section id="what-would-exact-origin-look-like-if-both-servers-are-running-on-the-host-dgx-but-listening-on-different-ports" class="level4">
<h4 class="anchored" data-anchor-id="what-would-exact-origin-look-like-if-both-servers-are-running-on-the-host-dgx-but-listening-on-different-ports">What would exact origin look like if both servers are running on the host “dgx” but listening on different ports?</h4>
<p>If both servers are running on the host “dgx” but listening on different ports, you would specify the exact origin by including the protocol, hostname, and port number. For example, if your React application is running on port 3000 and your API server is running on port 4444, you would set the <code>Access-Control-Allow-Origin</code> header to <code>http://dgx:3000</code> on your API server.</p>
<p>Here’s how you can configure it for an Express.js server:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">'express'</span>)<span class="op">;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cors <span class="op">=</span> <span class="pp">require</span>(<span class="st">'cors'</span>)<span class="op">;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>({</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">origin</span><span class="op">:</span> <span class="st">'http://dgx:3000'</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Your routes here</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(<span class="dv">4444</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Server is running on port 4444'</span>)<span class="op">;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This configuration allows requests from <code>http://dgx:3000</code> to access resources on your API server running on <code>http://dgx:4444</code>.</p>
<blockquote class="blockquote">
<p>Tokens: 6.9k sent, 201 received. Cost: $0.02 message, $0.10 session.</p>
</blockquote>
</section>
<section id="ask-what-would-the-raw-http-header-look-like-from-the-server-in-that-case" class="level4">
<h4 class="anchored" data-anchor-id="ask-what-would-the-raw-http-header-look-like-from-the-server-in-that-case">/ask What would the raw HTTP header look like from the server in that case?</h4>
</section>
<section id="what-would-the-raw-http-header-look-like-from-the-server-in-that-case" class="level4">
<h4 class="anchored" data-anchor-id="what-would-the-raw-http-header-look-like-from-the-server-in-that-case">What would the raw HTTP header look like from the server in that case?</h4>
<p>If you configure your server to allow requests from a specific origin, such as <code>http://dgx:3000</code>, the raw HTTP response header from the server would include the <code>Access-Control-Allow-Origin</code> header specifying that origin. Here’s what the relevant part of the HTTP response headers might look like:</p>
<pre><code>HTTP/1.1 200 OK
Content-Type: application/json
Access-Control-Allow-Origin: http://dgx:3000</code></pre>
<p>This header tells the browser that the resource can be accessed by web pages from the specified origin (<code>http://dgx:3000</code>). If you have additional CORS-related headers, such as those for handling credentials or specific HTTP methods, they might look like this:</p>
<pre><code>Access-Control-Allow-Origin: http://dgx:3000
Access-Control-Allow-Credentials: true
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization</code></pre>
<ul>
<li><strong>Access-Control-Allow-Origin</strong>: Specifies the origin that is allowed to access the resource.</li>
<li><strong>Access-Control-Allow-Credentials</strong>: Indicates whether the response to the request can be exposed when the credentials flag is true.</li>
<li><strong>Access-Control-Allow-Methods</strong>: Lists the HTTP methods that are allowed when accessing the resource.</li>
<li><strong>Access-Control-Allow-Headers</strong>: Lists the headers that can be used when making the actual request.</li>
</ul>
<p>These headers are part of the CORS protocol and help manage cross-origin requests securely.</p>
<blockquote class="blockquote">
<p>Tokens: 4.9k sent, 291 received. Cost: $0.02 message, $0.11 session.</p>
</blockquote>
</section>
<section id="change-wiki.jsx-so-that-when-a-search-result-is-clicked-on-all-the-results-are-immediately-hiddendeleted-such-that-the-xml-content-is-the-only-thing-shown." class="level4">
<h4 class="anchored" data-anchor-id="change-wiki.jsx-so-that-when-a-search-result-is-clicked-on-all-the-results-are-immediately-hiddendeleted-such-that-the-xml-content-is-the-only-thing-shown.">Change Wiki.jsx so that when a search result is clicked on, all the results are immediately hidden/deleted, such that the xml content is the only thing shown.</h4>
<p>To modify the <code>Wiki.jsx</code> component so that the search results are hidden when a result is clicked, we need to clear the <code>results</code> state when an item is selected. Here are the changes:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span> <span class="co">// Clear results when an item is clicked</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change ensures that when a search result is clicked, the <code>results</code> state is cleared, effectively hiding the list of search results and displaying only the XML content.</p>
<blockquote class="blockquote">
<p>Tokens: 7.4k sent, 119 received. Cost: $0.02 message, $0.13 session.<br>
Committing src/Wiki.jsx before applying edits.<br>
Commit f214e0c fix: Update fetch URLs from localhost to dgx in Wiki component<br>
Applied edit to src/Wiki.jsx<br>
Commit 7b60e12 feat: Clear search results when a search result is clicked in Wiki.jsx<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="change-the-search-box-so-that-the-search-request-is-only-dispatched-when-three-or-more-characters-have-been-typed." class="level4">
<h4 class="anchored" data-anchor-id="change-the-search-box-so-that-the-search-request-is-only-dispatched-when-three-or-more-characters-have-been-typed.">Change the search box so that the search request is only dispatched when three or more characters have been typed.</h4>
<p>To ensure that the search request is only dispatched when three or more characters have been typed, we need to modify the condition in the <code>handleSearch</code> function. Here is the change:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>() <span class="op">!==</span> <span class="st">""</span>) {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change updates the condition to check if the trimmed input length is three or more before dispatching the search request.</p>
<blockquote class="blockquote">
<p>Tokens: 6.2k sent, 98 received. Cost: $0.02 message, $0.15 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 7c4a4d3 feat: Dispatch search request only after three or more characters typed<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="change-the-handleresultclick-logic-so-that-when-an-item-is-clicked-the-string-contents-are-placed-into-the-search-bar-but-no-new-search-is-conducted." class="level4">
<h4 class="anchored" data-anchor-id="change-the-handleresultclick-logic-so-that-when-an-item-is-clicked-the-string-contents-are-placed-into-the-search-bar-but-no-new-search-is-conducted.">Change the “handleResultClick” logic so that when an item is clicked, the string contents are placed into the Search bar, but <em>no</em> new search is conducted.</h4>
<p>To modify the <code>handleResultClick</code> function so that the clicked item’s string content is placed into the search bar without conducting a new search, we need to update the logic to set the <code>query</code> state without triggering the search. Here is the change:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(xmlData)<span class="op">;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(xmlData)<span class="op">;</span> <span class="co">// Place the string content into the search bar</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(xmlData)<span class="op">;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change ensures that when an item is clicked, its content is placed into the search bar, and the search results are cleared without initiating a new search.</p>
<blockquote class="blockquote">
<p>Tokens: 6.4k sent, 128 received. Cost: $0.02 message, $0.16 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 1feb90d feat: Update handleResultClick to set query without triggering search<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="change-the-wiki-logic-so-that-theres-a-one-second-delay-of-no-typing-before-a-search-is-dispatched.-if-another-key-comes-in-before-1-second-the-timer-is-reset.-only-dispatch-a-search-if-there-has-been-no-typing-for-at-least-a-second." class="level4">
<h4 class="anchored" data-anchor-id="change-the-wiki-logic-so-that-theres-a-one-second-delay-of-no-typing-before-a-search-is-dispatched.-if-another-key-comes-in-before-1-second-the-timer-is-reset.-only-dispatch-a-search-if-there-has-been-no-typing-for-at-least-a-second.">Change the Wiki logic so that there’s a one second delay of no typing before a search is dispatched. If another key comes in before 1 second, the timer is reset. Only dispatch a search if there has been no typing for at least a second.</h4>
<p>To implement a one-second delay before dispatching a search request, we can use a debounce technique. This involves setting a timeout that resets every time a new key is pressed. Here’s how you can modify the <code>Wiki.jsx</code> file:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle input change and fetch search results</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleSearch <span class="op">=</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> value <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setQuery</span>(value)<span class="op">;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Debounce search function</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> searchTimeout <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleSearch <span class="op">=</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> value <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setQuery</span>(value)<span class="op">;</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (searchTimeout) {</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearTimeout</span>(searchTimeout)<span class="op">;</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (error) {</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change introduces a debounce mechanism by using a <code>setTimeout</code> that delays the search request by one second. If another key is pressed before the timeout completes, the timer is reset.</p>
<blockquote class="blockquote">
<p>Tokens: 6.7k sent, 387 received. Cost: $0.02 message, $0.19 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 65f7959 feat: Implement debounce for search input with one second delay<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="when-a-search-result-is-clicked-on-e.g.-python-programming-language-only-that-text-should-be-placed-in-the-search-box-not-the-results-of-the-search." class="level4">
<h4 class="anchored" data-anchor-id="when-a-search-result-is-clicked-on-e.g.-python-programming-language-only-that-text-should-be-placed-in-the-search-box-not-the-results-of-the-search.">When a search result is clicked on, e.g.&nbsp;“Python (Programming Language)”, only that text should be placed in the search box, not the results of the search.</h4>
<p>To ensure that only the text of the clicked search result is placed in the search box, we need to update the <code>handleResultClick</code> function to set the <code>query</code> state with the result’s name instead of the XML data. Here is the change:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleResultClick <span class="op">=</span> <span class="kw">async</span> (startByte<span class="op">,</span> endByte) <span class="kw">=&gt;</span> {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleResultClick <span class="op">=</span> <span class="kw">async</span> (name<span class="op">,</span> startByte<span class="op">,</span> endByte) <span class="kw">=&gt;</span> {</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(xmlData)<span class="op">;</span> <span class="co">// Place the string content into the search bar</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(name)<span class="op">;</span> <span class="co">// Place the result's name into the search bar</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>          onClick<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">handleResultClick</span>(startByte<span class="op">,</span> endByte)}</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>          onClick<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">handleResultClick</span>(name<span class="op">,</span> startByte<span class="op">,</span> endByte)}</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes ensure that when a search result is clicked, only the result’s name is placed in the search box, and the XML data is still fetched and displayed.</p>
<blockquote class="blockquote">
<p>Tokens: 6.5k sent, 230 received. Cost: $0.02 message, $0.20 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 7b93ced fix: Update search result click handler to set query with result name<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="the-search-results-should-take-up-as-much-vertical-space-as-there-is-left-on-the-page.-currently-the-entire-line-is-being-displayed-as-a-single-line-with-a-horizontal-scroll-bar." class="level4">
<h4 class="anchored" data-anchor-id="the-search-results-should-take-up-as-much-vertical-space-as-there-is-left-on-the-page.-currently-the-entire-line-is-being-displayed-as-a-single-line-with-a-horizontal-scroll-bar.">The search results should take up as much vertical space as there is left on the page. Currently the entire line is being displayed as a single line with a horizontal scroll bar.</h4>
<p>To ensure that the search results take up as much vertical space as possible and to prevent horizontal scrolling, we can adjust the CSS styles in <code>App.scss</code> to allow the list to expand and wrap text. Here are the changes:</p>
<p>src/App.scss</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode scss code-with-copy"><code class="sourceCode scss"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>&lt;&lt;&lt;&lt;&lt;&lt;&lt; SEARCH</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">margin-top</span>: <span class="dv">20</span><span class="dt">px</span><span class="op">;</span> <span class="co">// Add vertical space between the tab and the search box</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>=======</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> {</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">margin-top</span>: <span class="dv">20</span><span class="dt">px</span><span class="op">;</span> <span class="co">// Add vertical space between the tab and the search box</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">display</span>: <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">flex-direction</span>: <span class="dv">column</span><span class="op">;</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">height</span>: <span class="dv">100</span><span class="dt">vh</span><span class="op">;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> <span class="fu">.list-group</span> {</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">flex-grow</span>: <span class="dv">1</span><span class="op">;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">overflow-y</span>: <span class="bu">auto</span><span class="op">;</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> <span class="fu">.list-group-item</span> {</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">white-space</span>: <span class="dv">normal</span><span class="op">;</span> <span class="co">// Allow text to wrap</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will make the search results list take up the remaining vertical space and allow the text to wrap, preventing horizontal scrolling.</p>
<blockquote class="blockquote">
<p>Tokens: 6.8k sent, 201 received. Cost: $0.02 message, $0.22 session.<br>
Applied edit to src/App.scss<br>
Commit aad00d5 style: Adjust search results container for vertical space and text wrapping<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="when-the-search-box-is-cleared-both-the-search-results-and-article-elements-should-be-hiddenremovedcleared." class="level4">
<h4 class="anchored" data-anchor-id="when-the-search-box-is-cleared-both-the-search-results-and-article-elements-should-be-hiddenremovedcleared.">When the search box is cleared, both the search results and article elements should be hidden/removed/cleared.</h4>
<p>To ensure that both the search results and article elements are cleared when the search box is cleared, we need to update the <code>handleSearch</code> function to reset the <code>selectedXml</code> state when the query is empty. Here is the change:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// Clear selected XML when the search box is cleared</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change will ensure that when the search box is cleared, both the search results and the selected article are hidden/removed.</p>
<blockquote class="blockquote">
<p>Tokens: 6.1k sent, 114 received. Cost: $0.02 message, $0.24 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 47b425f fix: Clear selected XML when the search box is cleared<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="when-a-new-character-is-typed-all-outstanding-searches-should-be-immediately-cancelled.-if-they-have-results-that-are-received-after-the-cancellation-point-the-results-should-be-discarded-immediately." class="level4">
<h4 class="anchored" data-anchor-id="when-a-new-character-is-typed-all-outstanding-searches-should-be-immediately-cancelled.-if-they-have-results-that-are-received-after-the-cancellation-point-the-results-should-be-discarded-immediately.">When a new character is typed… all outstanding searches should be immediately cancelled. If they have results that are received after the “cancellation point”, the results should be discarded immediately.</h4>
<p>To implement the cancellation of outstanding searches and discard results received after the “cancellation point,” we can use an <code>AbortController</code> to manage the fetch requests. Here’s how you can modify the <code>handleSearch</code> function:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Debounce search function</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Debounce search function and abort controller for cancelling requests</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> abortControllerRef <span class="op">=</span> <span class="fu">useRef</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (searchTimeout) {</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>      abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span> <span class="co">// Cancel any ongoing fetch requests</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (searchTimeout) {</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        abortControllerRef<span class="op">.</span><span class="at">current</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> { signal } <span class="op">=</span> abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>            signal<span class="op">,</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">json</span>())</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((data) <span class="kw">=&gt;</span> {</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">catch</span>((error) <span class="kw">=&gt;</span> {</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">"AbortError"</span>) {</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>                <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will ensure that any ongoing search requests are cancelled when a new character is typed, and any results received after the cancellation will be discarded.</p>
<blockquote class="blockquote">
<p>Tokens: 6.3k sent, 381 received. Cost: $0.02 message, $0.26 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 4277f3d feat: Implement cancellation of outstanding searches on new input<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="multiline-mode" class="level4">
<h4 class="anchored" data-anchor-id="multiline-mode">/multiline-mode</h4>
<blockquote class="blockquote">
<p>Multiline mode: Enabled. Enter inserts newline, Alt-Enter submits text</p>
</blockquote>
</section>
<section id="ask-this-is-a-sample-piece-of-content-returned-by-the-selectedxml-bit" class="level4">
<h4 class="anchored" data-anchor-id="ask-this-is-a-sample-piece-of-content-returned-by-the-selectedxml-bit">/ask This is a sample piece of content returned by the “selectedXml” bit:</h4>
</section>
<section id="section" class="level4">
<h4 class="anchored" data-anchor-id="section"></h4>
#### <page>
<title>
Test (Unix)
</title>
<p><ns>0</ns> <id>2491736</id> <revision> <id>629490168</id> <parentid>629490063</parentid> <timestamp>2014-10-13T21:13:12Z</timestamp> <contributor> <ip>2A02:580:B0ED:E300:9DBB:3B15:8A21:F31E</ip> </contributor> <comment>/* Description <em>/</em></comment><em> <model>wikitext</model> <format>text/x-wiki</format> <text xml:space="preserve">{{lowercase|title= test (Unix)}} ’‘’test’’’ is a [[command line interface|command-line]] utility found in [[Unix-like]] operating systems that evaluates [[Conditional (programming)|conditional expressions]]. ==Syntax== test ‘’expression’’ or [ ‘’expression’’ ] ==Description== The &lt;code&gt;test&lt;/code&gt; command in Unix evaluates the &lt;code&gt;expression&lt;/code&gt; parameter. In some shells such as [[FreeBSD]] &lt;code&gt;sh(1)&lt;/code&gt; it is a [[shell builtin]], even though the external version still exists. In the second form of the command, the &lt;code&gt;[ ]&lt;/code&gt; (brackets) must be surrounded by blank spaces. This is because &lt;code&gt;[&lt;/code&gt; is a program and [[POSIX]] compatible shells require a space between the program name and its arguments. One must test explicitly for file names in the C shell. File-name substitution ([[glob (programming)|globbing]]) causes the shell script to exit. == Arguments == The following arguments are used to construct this parameter: ’’‘-e’’’ FileName - FileName exists All remaining arguments return true if the object (file or string) exists, and the condition specified is true. ’’‘-b’’’ Filename - Returns a True exit value if the specified FileName exists and is a block special file ’’‘-c’’’ FileName - FileName is a [[character special file]] ’’‘-d’’’ FileName - FileName is a [[directory (file systems)|directory]] ’’‘-f’’’ FileName - FileName is a regular file ’’‘-g’’’ FileName - FileName’s Set [[Group identifier (Unix)|Group ID]] bit is set ’’‘-h’’’ FileName - FileName is a [[symbolic link]] ’’‘-k’’’ FileName - FileName’s sticky bit is set ’’‘-L’’’ FileName - FileName is a [[symbolic link]] ’’‘-p’’’ FileName - FileName is a [[named pipe]] (FIFO) ’’‘-r’’’ FileName - FileName is readable by the current process ’’‘-s’’’ FileName - FileName has a size greater than 0 ’’‘-t’’’ FileDescriptor - [[File descriptor|FileDescriptor]] is open and associated with a [[pseudo terminal|terminal]] ’’‘-u’’’ FileName - FileName’s Set [[User identifier (Unix)|User ID]] bit is set ’’‘-w’’’ FileName - FileName’s write flag is on. However, the FileName will not be writable on a read-only file system even if test indicates true ’’‘-x’’’ FileName - FileName’s [[Execution (computers)|execute]] flag is on If the specified file exists and is a directory, the &lt;code&gt;True&lt;/code&gt; exit value indicates that the current process has permission to change &lt;code&gt;cd&lt;/code&gt; into the directory. file1 ’’‘-nt’’’ file2 - file1 is newer than file2 file1 ’’‘-ot’’’ file2 - file1 is older than file2 file1 ’’‘-ef’’’ file2 - file1 is another name for file2 - ([[symbolic link]] or [[hard link]]) === String arguments === In [[Perl]], these sections are reversed: &lt;code&gt;eq&lt;/code&gt; is a string operator and &lt;code&gt;==&lt;/code&gt; is a numerical operator, and so on for the others. ’’‘-n’’’ String1 - the length of the String1 variable is nonzero ’’‘-z’’’ String1 - the length of the String1 variable is 0 (zero) String1 ’’‘=’’’ String2 - String1 and String2 variables are identical String1 ’’‘!=’’’ String2 - String1 and String2 variables are not identical String1 - String1 variable is not a null string === Number arguments === Integer1 ’’‘-eq’’’ Integer2 - Integer1 and Integer2 variables are [[algebra]]ically equal ’’‘-ne’’’ - not equal ’’‘-gt’’’ - greater than ’’‘-ge’’’ - greater or equal ’’‘-lt’’’ - less than ’’‘-le’’’ - less or equal === Operators === &lt;code&gt;test&lt;/code&gt; arguments can be combined with the following operators: ’’‘!’’’ - Unary negation operator ’’‘-a’’’ - Binary AND operator ’’‘-o’’’ - Binary OR operator (the &lt;code&gt;-a&lt;/code&gt; operator has higher precedence than the &lt;code&gt;-o&lt;/code&gt; operator) ’’‘(Expression)’’’ - Parentheses for grouping must be escaped with a backslash &lt;code&gt;&amp;lt;/code&gt; The &lt;code&gt;-a&lt;/code&gt; and &lt;code&gt;-o&lt;/code&gt; operators, along with parentheses for grouping, are XSI extensions&lt;ref&gt;[http://www.opengroup.org/onlinepubs/009695399/utilities/test.html IEEE Std 1003.1, 2004, documentation for &lt;code&gt;test&lt;/code&gt;]&lt;/ref&gt; and are therefore not portable. In portable shell scripts, the same effect may be achieved by connecting multiple invocations of &lt;code&gt;test&lt;/code&gt; together with the &lt;code&gt;&amp;&amp;&lt;/code&gt; and &lt;code&gt;||&lt;/code&gt; operators and parentheses. ==Exit Status== This command returns the following exit values: ’‘’0’’’ - The Expression parameter is true ’‘’1’’’ - The Expression parameter is false or missing ’’‘&gt;1’’’ - An error occurred ==Examples== 1. To test whether a file is nonexistent or empty, type:&lt;!– touch(1) -s file True if file exists and has a size greater than zero. –&gt; &lt;source lang="bash"&gt; if test ! -s "$1" then echo $1 does not exist or is empty. fi &lt;/source&gt; If the file specified by the first positional parameter to the shell procedure, $1, does not exist or is of size 0, the test command displays the message. If $1 exists and has a size greater than 0, the test command displays nothing. Note: There must be a space between the -s function and the file name. The quotation marks around $1 ensure that the test works properly even if the value of $1 is a null string. If the quotation marks are omitted and $1 is the empty string, the test command displays the error message: test: argument expected. 2. To do a complex comparison, type: &lt;source lang="bash"&gt; if [ $# -lt 2 -o ! -e "$1" ] then exit fi &lt;/source&gt; If the shell procedure is given fewer than two positional parameters or the file specified by $1 does not exist, then the shell procedure exits. The special shell variable $# represents the number of positional parameters entered on the command line that starts this shell procedure. ==See also== </text></em>[[List of Unix utilities]] * [[Bourne shell]] * [[Korn shell|KornShell]]&lt;!– KornShell is the proper name as written by its author –&gt; * [[Z Shell]] * [[GNU]] &lt;tt&gt;[[Bash (Unix shell)|bash]]&lt;/tt&gt; * [[C shell]] * &lt;tt&gt;[[tcsh]]&lt;/tt&gt; * &lt;tt&gt;[[find]]&lt;/tt&gt; ==References== &lt;!–&lt;nowiki&gt; See http://en.wikipedia.org/wiki/Wikipedia:Footnotes for an explanation of how to generate footnotes using the &lt;ref&gt; and &lt;/ref&gt; tags, and the template below. &lt;/nowiki&gt;–&gt; &lt;references/&gt; {{Unix commands}} [[Category:Unix SUS2008 utilities]] [[Category:Conditional constructs]] <sha1>6brs4q3f4obygm6jejvcafone0ck2k9</sha1> </revision> <br>
####<br>
#### It’s still not displaying as a multiline chunk of text. How can I render it nicely as, let’s say XML output?</p>
</page></section>
<section id="this-is-a-sample-piece-of-content-returned-by-the-selectedxml-bit" class="level4">
<h4 class="anchored" data-anchor-id="this-is-a-sample-piece-of-content-returned-by-the-selectedxml-bit">This is a sample piece of content returned by the “selectedXml” bit:</h4>
</section>
<section id="section-1" class="level4">
<h4 class="anchored" data-anchor-id="section-1"></h4>
#### <page>
<title>
Test (Unix)
</title>
<p><ns>0</ns> <id>2491736</id> <revision> <id>629490168</id> <parentid>629490063</parentid> <timestamp>2014-10-13T21:13:12Z</timestamp> <contributor> <ip>2A02:580:B0ED:E300:9DBB:3B15:8A21:F31E</ip> </contributor> <comment>/* Description <em>/</em></comment><em> <model>wikitext</model> <format>text/x-wiki</format> <text xml:space="preserve">{{lowercase|title= test (Unix)}} ’‘’test’’’ is a [[command line interface|command-line]] utility found in [[Unix-like]] operating systems that evaluates [[Conditional (programming)|conditional expressions]]. ==Syntax== test ‘’expression’’ or [ ‘’expression’’ ] ==Description== The &lt;code&gt;test&lt;/code&gt; command in Unix evaluates the &lt;code&gt;expression&lt;/code&gt; parameter. In some shells such as [[FreeBSD]] &lt;code&gt;sh(1)&lt;/code&gt; it is a [[shell builtin]], even though the external version still exists. In the second form of the command, the &lt;code&gt;[ ]&lt;/code&gt; (brackets) must be surrounded by blank spaces. This is because &lt;code&gt;[&lt;/code&gt; is a program and [[POSIX]] compatible shells require a space between the program name and its arguments. One must test explicitly for file names in the C shell. File-name substitution ([[glob (programming)|globbing]]) causes the shell script to exit. == Arguments == The following arguments are used to construct this parameter: ’’‘-e’’’ FileName - FileName exists All remaining arguments return true if the object (file or string) exists, and the condition specified is true. ’’‘-b’’’ Filename - Returns a True exit value if the specified FileName exists and is a block special file ’’‘-c’’’ FileName - FileName is a [[character special file]] ’’‘-d’’’ FileName - FileName is a [[directory (file systems)|directory]] ’’‘-f’’’ FileName - FileName is a regular file ’’‘-g’’’ FileName - FileName’s Set [[Group identifier (Unix)|Group ID]] bit is set ’’‘-h’’’ FileName - FileName is a [[symbolic link]] ’’‘-k’’’ FileName - FileName’s sticky bit is set ’’‘-L’’’ FileName - FileName is a [[symbolic link]] ’’‘-p’’’ FileName - FileName is a [[named pipe]] (FIFO) ’’‘-r’’’ FileName - FileName is readable by the current process ’’‘-s’’’ FileName - FileName has a size greater than 0 ’’‘-t’’’ FileDescriptor - [[File descriptor|FileDescriptor]] is open and associated with a [[pseudo terminal|terminal]] ’’‘-u’’’ FileName - FileName’s Set [[User identifier (Unix)|User ID]] bit is set ’’‘-w’’’ FileName - FileName’s write flag is on. However, the FileName will not be writable on a read-only file system even if test indicates true ’’‘-x’’’ FileName - FileName’s [[Execution (computers)|execute]] flag is on If the specified file exists and is a directory, the &lt;code&gt;True&lt;/code&gt; exit value indicates that the current process has permission to change &lt;code&gt;cd&lt;/code&gt; into the directory. file1 ’’‘-nt’’’ file2 - file1 is newer than file2 file1 ’’‘-ot’’’ file2 - file1 is older than file2 file1 ’’‘-ef’’’ file2 - file1 is another name for file2 - ([[symbolic link]] or [[hard link]]) === String arguments === In [[Perl]], these sections are reversed: &lt;code&gt;eq&lt;/code&gt; is a string operator and &lt;code&gt;==&lt;/code&gt; is a numerical operator, and so on for the others. ’’‘-n’’’ String1 - the length of the String1 variable is nonzero ’’‘-z’’’ String1 - the length of the String1 variable is 0 (zero) String1 ’’‘=’’’ String2 - String1 and String2 variables are identical String1 ’’‘!=’’’ String2 - String1 and String2 variables are not identical String1 - String1 variable is not a null string === Number arguments === Integer1 ’’‘-eq’’’ Integer2 - Integer1 and Integer2 variables are [[algebra]]ically equal ’’‘-ne’’’ - not equal ’’‘-gt’’’ - greater than ’’‘-ge’’’ - greater or equal ’’‘-lt’’’ - less than ’’‘-le’’’ - less or equal === Operators === &lt;code&gt;test&lt;/code&gt; arguments can be combined with the following operators: ’’‘!’’’ - Unary negation operator ’’‘-a’’’ - Binary AND operator ’’‘-o’’’ - Binary OR operator (the &lt;code&gt;-a&lt;/code&gt; operator has higher precedence than the &lt;code&gt;-o&lt;/code&gt; operator) ’’‘(Expression)’’’ - Parentheses for grouping must be escaped with a backslash &lt;code&gt;&amp;lt;/code&gt; The &lt;code&gt;-a&lt;/code&gt; and &lt;code&gt;-o&lt;/code&gt; operators, along with parentheses for grouping, are XSI extensions&lt;ref&gt;[http://www.opengroup.org/onlinepubs/009695399/utilities/test.html IEEE Std 1003.1, 2004, documentation for &lt;code&gt;test&lt;/code&gt;]&lt;/ref&gt; and are therefore not portable. In portable shell scripts, the same effect may be achieved by connecting multiple invocations of &lt;code&gt;test&lt;/code&gt; together with the &lt;code&gt;&amp;&amp;&lt;/code&gt; and &lt;code&gt;||&lt;/code&gt; operators and parentheses. ==Exit Status== This command returns the following exit values: ’‘’0’’’ - The Expression parameter is true ’‘’1’’’ - The Expression parameter is false or missing ’’‘&gt;1’’’ - An error occurred ==Examples== 1. To test whether a file is nonexistent or empty, type:&lt;!– touch(1) -s file True if file exists and has a size greater than zero. –&gt; &lt;source lang="bash"&gt; if test ! -s "$1" then echo $1 does not exist or is empty. fi &lt;/source&gt; If the file specified by the first positional parameter to the shell procedure, $1, does not exist or is of size 0, the test command displays the message. If $1 exists and has a size greater than 0, the test command displays nothing. Note: There must be a space between the -s function and the file name. The quotation marks around $1 ensure that the test works properly even if the value of $1 is a null string. If the quotation marks are omitted and $1 is the empty string, the test command displays the error message: test: argument expected. 2. To do a complex comparison, type: &lt;source lang="bash"&gt; if [ $# -lt 2 -o ! -e "$1" ] then exit fi &lt;/source&gt; If the shell procedure is given fewer than two positional parameters or the file specified by $1 does not exist, then the shell procedure exits. The special shell variable $# represents the number of positional parameters entered on the command line that starts this shell procedure. ==See also== </text></em>[[List of Unix utilities]] * [[Bourne shell]] * [[Korn shell|KornShell]]&lt;!– KornShell is the proper name as written by its author –&gt; * [[Z Shell]] * [[GNU]] &lt;tt&gt;[[Bash (Unix shell)|bash]]&lt;/tt&gt; * [[C shell]] * &lt;tt&gt;[[tcsh]]&lt;/tt&gt; * &lt;tt&gt;[[find]]&lt;/tt&gt; ==References== &lt;!–&lt;nowiki&gt; See http://en.wikipedia.org/wiki/Wikipedia:Footnotes for an explanation of how to generate footnotes using the &lt;ref&gt; and &lt;/ref&gt; tags, and the template below. &lt;/nowiki&gt;–&gt; &lt;references/&gt; {{Unix commands}} [[Category:Unix SUS2008 utilities]] [[Category:Conditional constructs]] <sha1>6brs4q3f4obygm6jejvcafone0ck2k9</sha1> </revision> <br>
####<br>
#### It’s still not displaying as a multiline chunk of text. How can I render it nicely as, let’s say XML output?<br>
&gt; http://www.opengroup.org/onlinepubs/009695399/utilities/test.html<br>
&gt; Add URL to the chat? (Y)es/(N)o/(A)ll/(S)kip all/(D)on’t ask again [Yes]: d<br>
&gt; http://en.wikipedia.org/wiki/Wikipedia:Footnotes<br>
&gt; Add URL to the chat? (Y)es/(N)o/(A)ll/(S)kip all/(D)on’t ask again [Yes]: s</p>
<p>To render the XML content nicely as multiline text with proper formatting, you can use a library like <code>react-syntax-highlighter</code> to display the XML with syntax highlighting. Here’s how you can modify the <code>Wiki.jsx</code> file to achieve this:</p>
<ol type="1">
<li><p>Install the <code>react-syntax-highlighter</code> package if you haven’t already:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install react-syntax-highlighter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Update the <code>Wiki.jsx</code> file to use the syntax highlighter:</p></li>
</ol>
<div class="sourceCode" id="cb50"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React<span class="op">,</span> { useState<span class="op">,</span> useRef } <span class="im">from</span> <span class="st">"react"</span><span class="op">;</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Container<span class="op">,</span> Form<span class="op">,</span> FormControl<span class="op">,</span> ListGroup<span class="op">,</span> Card } <span class="im">from</span> <span class="st">"react-bootstrap"</span><span class="op">;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Prism <span class="im">as</span> SyntaxHighlighter } <span class="im">from</span> <span class="st">"react-syntax-highlighter"</span><span class="op">;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { solarizedlight } <span class="im">from</span> <span class="st">"react-syntax-highlighter/dist/esm/styles/prism"</span><span class="op">;</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Wiki <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [query<span class="op">,</span> setQuery] <span class="op">=</span> <span class="fu">useState</span>(<span class="st">""</span>)<span class="op">;</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [results<span class="op">,</span> setResults] <span class="op">=</span> <span class="fu">useState</span>([])<span class="op">;</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [selectedXml<span class="op">,</span> setSelectedXml] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> abortControllerRef <span class="op">=</span> <span class="fu">useRef</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> searchTimeout <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleSearch <span class="op">=</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> value <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setQuery</span>(value)<span class="op">;</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>      abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (searchTimeout) {</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearTimeout</span>(searchTimeout)<span class="op">;</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>        abortControllerRef<span class="op">.</span><span class="at">current</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> { signal } <span class="op">=</span> abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">;</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>            signal<span class="op">,</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">json</span>())</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((data) <span class="kw">=&gt;</span> {</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">catch</span>((error) <span class="kw">=&gt;</span> {</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">"AbortError"</span>) {</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>                <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>                <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (error) {</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleResultClick <span class="op">=</span> <span class="kw">async</span> (name<span class="op">,</span> startByte<span class="op">,</span> endByte) <span class="kw">=&gt;</span> {</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/xml`</span><span class="op">,</span> {</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Range</span><span class="op">:</span> <span class="vs">`bytes=</span><span class="sc">${</span>startByte<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>endByte<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> xmlData <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(name)<span class="op">;</span></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(xmlData)<span class="op">;</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching XML data:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>Container className<span class="op">=</span><span class="st">"wiki-search-container"</span><span class="op">&gt;</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>Form<span class="op">&gt;</span></span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>FormControl</span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>          type<span class="op">=</span><span class="st">"search"</span></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>          placeholder<span class="op">=</span><span class="st">"Search"</span></span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a>          className<span class="op">=</span><span class="st">"me-2"</span></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>          aria<span class="op">-</span>label<span class="op">=</span><span class="st">"Search"</span></span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>          value<span class="op">=</span>{query}</span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>          onChange<span class="op">=</span>{handleSearch}</span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">/&gt;</span></span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;/</span>Form<span class="op">&gt;</span></span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>      {results<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> (</span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>ListGroup className<span class="op">=</span><span class="st">"mt-3"</span><span class="op">&gt;</span></span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>          {results<span class="op">.</span><span class="fu">map</span>(([name<span class="op">,</span> startByte<span class="op">,</span> endByte]) <span class="kw">=&gt;</span> (</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>ListGroup<span class="op">.</span><span class="at">Item</span></span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>              key<span class="op">=</span>{<span class="vs">`</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>startByte<span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>              action</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a>              onClick<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">handleResultClick</span>(name<span class="op">,</span> startByte<span class="op">,</span> endByte)}</span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">&gt;</span></span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>              {name}</span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;/</span>ListGroup<span class="op">.</span><span class="at">Item</span><span class="op">&gt;</span></span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>          ))}</span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>ListGroup<span class="op">&gt;</span></span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a>      )}</span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a>      {selectedXml <span class="op">&amp;&amp;</span> (</span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>Card className<span class="op">=</span><span class="st">"mt-3"</span><span class="op">&gt;</span></span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>Card<span class="op">.</span><span class="at">Body</span><span class="op">&gt;</span></span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>SyntaxHighlighter language<span class="op">=</span><span class="st">"xml"</span> style<span class="op">=</span>{solarizedlight}<span class="op">&gt;</span></span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a>              {selectedXml}</span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;/</span>SyntaxHighlighter<span class="op">&gt;</span></span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;/</span>Card<span class="op">.</span><span class="at">Body</span><span class="op">&gt;</span></span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>Card<span class="op">&gt;</span></span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a>      )}</span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>Container<span class="op">&gt;</span></span>
<span id="cb50-110"><a href="#cb50-110" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb50-111"><a href="#cb50-111" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb50-112"><a href="#cb50-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-113"><a href="#cb50-113" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> Wiki<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code uses <code>react-syntax-highlighter</code> to render the XML content with syntax highlighting, making it easier to read and visually appealing. You can choose different styles from the library to match your application’s theme.</p>
<blockquote class="blockquote">
<p>Tokens: 6.6k sent, 823 received. Cost: $0.02 message, $0.28 session.</p>
</blockquote>
</page></section>
<section id="please-make-that-change." class="level4">
<h4 class="anchored" data-anchor-id="please-make-that-change.">Please make that change.</h4>
<p>To render the XML content nicely with syntax highlighting, we will use the <code>react-syntax-highlighter</code> package. Here are the changes needed in <code>src/Wiki.jsx</code>:</p>
<p>First, ensure you have installed the <code>react-syntax-highlighter</code> package:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install react-syntax-highlighter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, update the <code>src/Wiki.jsx</code> file:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React<span class="op">,</span> { useState<span class="op">,</span> useRef } <span class="im">from</span> <span class="st">"react"</span><span class="op">;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React<span class="op">,</span> { useState<span class="op">,</span> useRef } <span class="im">from</span> <span class="st">"react"</span><span class="op">;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Prism <span class="im">as</span> SyntaxHighlighter } <span class="im">from</span> <span class="st">"react-syntax-highlighter"</span><span class="op">;</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { solarizedlight } <span class="im">from</span> <span class="st">"react-syntax-highlighter/dist/esm/styles/prism"</span><span class="op">;</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>pre<span class="op">&gt;</span>{selectedXml}<span class="op">&lt;/</span>pre<span class="op">&gt;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>SyntaxHighlighter language<span class="op">=</span><span class="st">"xml"</span> style<span class="op">=</span>{solarizedlight}<span class="op">&gt;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>              {selectedXml}</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;/</span>SyntaxHighlighter<span class="op">&gt;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will render the XML content with syntax highlighting, making it more readable and visually appealing.</p>
<blockquote class="blockquote">
<p>Tokens: 9.7k sent, 221 received. Cost: $0.03 message, $0.31 session.<br>
Committing src/Wiki.jsx before applying edits.<br>
Commit 2daa847 feat: Add useRef import to Wiki component for future enhancements<br>
Applied edit to src/Wiki.jsx<br>
Commit 2882b76 feat: Add XML syntax highlighting in Wiki component using react-syntax-highlighter<br>
npm install react-syntax-highlighter<br>
Run shell command? (Y)es/(N)o/(D)on’t ask again [Yes]: n<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="under-the-search-box-add-a-component-of-some-sort-that-will-be-used-to-display-some-information-about-the-search-results-received.-e.g.-if-i-type-in-python-there-should-be-some-light-read-only-text-under-the-search-bar-that-initially-says-searching-for-python-when-results-are-received-the-text-should-say-received-results-for-python-with-n-changing-as-more-results-are-received." class="level4">
<h4 class="anchored" data-anchor-id="under-the-search-box-add-a-component-of-some-sort-that-will-be-used-to-display-some-information-about-the-search-results-received.-e.g.-if-i-type-in-python-there-should-be-some-light-read-only-text-under-the-search-bar-that-initially-says-searching-for-python-when-results-are-received-the-text-should-say-received-results-for-python-with-n-changing-as-more-results-are-received.">Under the search box, add a component of some sort that will be used to display some information about the search results received. E.g. if I type in “Python”, there should be some light read-only text under the search bar that initially says “Searching for ‘Python’…”, when results are received, the text should say “Received <n> results for ‘Python’…”, with N changing as more results are received.</n></h4>
<p>To add a component that displays information about the search results, we will update the <code>src/Wiki.jsx</code> file to include a new state variable for the search status message and update it accordingly during the search process.</p>
<p>Here are the changes:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [selectedXml<span class="op">,</span> setSelectedXml] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [selectedXml<span class="op">,</span> setSelectedXml] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [searchStatus<span class="op">,</span> setSearchStatus] <span class="op">=</span> <span class="fu">useState</span>(<span class="st">""</span>)<span class="op">;</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setSearchStatus</span>(<span class="vs">`Searching for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">'...`</span>)<span class="op">;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setSearchStatus</span>(<span class="vs">`Received </span><span class="sc">${</span>data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> results for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">'...`</span>)<span class="op">;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>      {results<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> (</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">"search-status mt-2 text-muted"</span><span class="op">&gt;</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>        {searchStatus}</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will display a message under the search box indicating the current search status, updating as results are received.</p>
<blockquote class="blockquote">
<p>Tokens: 5.9k sent, 257 received. Cost: $0.02 message, $0.33 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 72544ab feat: Add search status display for user feedback during search process<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="update-the-statusline-to-capture-the-duration-it-took-e.g.-received-203-results-forpython-in-x.y-seconds." class="level4">
<h4 class="anchored" data-anchor-id="update-the-statusline-to-capture-the-duration-it-took-e.g.-received-203-results-forpython-in-x.y-seconds.">Update the statusline to capture the duration it took, e.g.&nbsp;“Received 203 results for”Python” in x.y seconds.”</h4>
<p>To capture the duration it took to receive the search results, we will update the <code>src/Wiki.jsx</code> file to measure the time taken for the fetch operation and include it in the status message.</p>
<p>Here are the changes:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setSearchStatus</span>(<span class="vs">`Received </span><span class="sc">${</span>data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> results for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">'...`</span>)<span class="op">;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> endTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> duration <span class="op">=</span> ((endTime <span class="op">-</span> startTime) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setSearchStatus</span>(<span class="vs">`Received </span><span class="sc">${</span>data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> results for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">' in </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs"> seconds.`</span>)<span class="op">;</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will update the status line to include the time taken to receive the search results.</p>
<blockquote class="blockquote">
<p>Tokens: 6.3k sent, 181 received. Cost: $0.02 message, $0.35 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 0487f16 feat: Update statusline to include duration of search results retrieval<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="if-there-is-no-text-in-the-search-box-hide-the-status-line." class="level4">
<h4 class="anchored" data-anchor-id="if-there-is-no-text-in-the-search-box-hide-the-status-line.">If there is no text in the search box, hide the status line.</h4>
<p>To hide the status line when there is no text in the search box, we can conditionally render the status line based on the <code>query</code> state. Here are the changes:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">"search-status mt-2 text-muted"</span><span class="op">&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>        {searchStatus}</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>      {query <span class="op">&amp;&amp;</span> (</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">"search-status mt-2 text-muted"</span><span class="op">&gt;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>          {searchStatus}</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>      )}</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change will ensure that the status line is only displayed when there is text in the search box.</p>
<blockquote class="blockquote">
<p>Tokens: 6.6k sent, 124 received. Cost: $0.02 message, $0.36 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 460f82b feat: Hide status line when search box is empty<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="review-the-search-bar-logic.-when-im-typing-fast-e.g.-if-i-type-trent-fast-where-each-character-is-definitely-being-typed-well-before-a-second-has-elapsed-the-app-is-still-dispatching-searches-for-each-keystroke.-i.e.-in-the-chrome-dev-console-i-can-see-that-200-fetch-requests-were-dispatched-for-tre-then-tren-then-trent.-we-should-be-waiting-for-at-least-a-second-to-see-if-there-has-been-any-more-typing-before-dispatching-a-fetch." class="level4">
<h4 class="anchored" data-anchor-id="review-the-search-bar-logic.-when-im-typing-fast-e.g.-if-i-type-trent-fast-where-each-character-is-definitely-being-typed-well-before-a-second-has-elapsed-the-app-is-still-dispatching-searches-for-each-keystroke.-i.e.-in-the-chrome-dev-console-i-can-see-that-200-fetch-requests-were-dispatched-for-tre-then-tren-then-trent.-we-should-be-waiting-for-at-least-a-second-to-see-if-there-has-been-any-more-typing-before-dispatching-a-fetch.">Review the search bar logic. When I’m typing fast, e.g.&nbsp;if I type Trent fast, where each character is definitely being typed well before a second has elapsed… the app is still dispatching searches for each keystroke. i.e.&nbsp;in the Chrome dev console I can see that 200 fetch requests were dispatched for ‘Tre’, then ‘Tren’, then ‘Trent’. We should be waiting for at least a second to see if there has been any more typing before dispatching a fetch.</h4>
<p>To ensure that the app waits for at least a second before dispatching a fetch request, we need to adjust the debounce logic in the <code>handleSearch</code> function. Specifically, we should clear the timeout and set a new one only if the user stops typing for a second.</p>
<p>Here are the changes:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setSearchStatus</span>(<span class="vs">`Searching for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">'...`</span>)<span class="op">;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>      abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span> <span class="co">// Cancel any ongoing fetch requests</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (searchTimeout) {</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearTimeout</span>(searchTimeout)<span class="op">;</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        abortControllerRef<span class="op">.</span><span class="at">current</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> { signal } <span class="op">=</span> abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">;</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>            <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>            signal<span class="op">,</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">json</span>())</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((data) <span class="kw">=&gt;</span> {</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> endTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> duration <span class="op">=</span> ((endTime <span class="op">-</span> startTime) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setSearchStatus</span>(<span class="vs">`Received </span><span class="sc">${</span>data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> results for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">' in </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs"> seconds.`</span>)<span class="op">;</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">catch</span>((error) <span class="kw">=&gt;</span> {</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">"AbortError"</span>) {</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>                <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>                <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (error) {</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// Clear selected XML when the search box is cleared</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (searchTimeout) {</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearTimeout</span>(searchTimeout)<span class="op">;</span></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSearchStatus</span>(<span class="vs">`Searching for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">'...`</span>)<span class="op">;</span></span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>          abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span> <span class="co">// Cancel any ongoing fetch requests</span></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>        abortControllerRef<span class="op">.</span><span class="at">current</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> { signal } <span class="op">=</span> abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">;</span></span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>            <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>            signal<span class="op">,</span></span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">json</span>())</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((data) <span class="kw">=&gt;</span> {</span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> endTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> duration <span class="op">=</span> ((endTime <span class="op">-</span> startTime) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setSearchStatus</span>(<span class="vs">`Received </span><span class="sc">${</span>data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> results for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">' in </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs"> seconds.`</span>)<span class="op">;</span></span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">catch</span>((error) <span class="kw">=&gt;</span> {</span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">"AbortError"</span>) {</span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a>                <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>                <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (error) {</span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSearchStatus</span>(<span class="st">""</span>)<span class="op">;</span></span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// Clear selected XML when the search box is cleared</span></span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change ensures that the search request is only dispatched if the user stops typing for at least one second, reducing unnecessary fetch requests.</p>
<blockquote class="blockquote">
<p>Tokens: 6.9k sent, 694 received. Cost: $0.02 message, $0.39 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit fb141da fix: Implement debounce logic for search requests to reduce fetch calls<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="ok-that-still-dispatches-calls-for-tre-tren-trent-cancels-all-three-of-them-then-dispatches-a-final-one-presumably-one-second-later-for-trent." class="level4">
<h4 class="anchored" data-anchor-id="ok-that-still-dispatches-calls-for-tre-tren-trent-cancels-all-three-of-them-then-dispatches-a-final-one-presumably-one-second-later-for-trent.">Ok that still dispatches calls for ‘Tre’, ‘Tren’, ‘Trent’, cancels all three of them, then dispatches a final one (presumably one second later) for ‘Trent’.</h4>
<p>To address the issue of multiple fetch requests being dispatched and canceled, we can improve the debounce logic by using a <code>useEffect</code> hook to manage the timeout. This will ensure that the fetch request is only dispatched after the user has stopped typing for a specified duration.</p>
<p>Here’s how you can implement this:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React<span class="op">,</span> { useState<span class="op">,</span> useRef } <span class="im">from</span> <span class="st">"react"</span><span class="op">;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React<span class="op">,</span> { useState<span class="op">,</span> useRef<span class="op">,</span> useEffect } <span class="im">from</span> <span class="st">"react"</span><span class="op">;</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> searchTimeout <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleSearch <span class="op">=</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> value <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setQuery</span>(value)<span class="op">;</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (searchTimeout) {</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearTimeout</span>(searchTimeout)<span class="op">;</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>      searchTimeout <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSearchStatus</span>(<span class="vs">`Searching for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">'...`</span>)<span class="op">;</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>          abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span> <span class="co">// Cancel any ongoing fetch requests</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>        abortControllerRef<span class="op">.</span><span class="at">current</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> { signal } <span class="op">=</span> abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">;</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>            signal<span class="op">,</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">json</span>())</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">then</span>((data) <span class="kw">=&gt;</span> {</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> endTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>              <span class="kw">const</span> duration <span class="op">=</span> ((endTime <span class="op">-</span> startTime) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>              <span class="fu">setSearchStatus</span>(<span class="vs">`Received </span><span class="sc">${</span>data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> results for '</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">' in </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs"> seconds.`</span>)<span class="op">;</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">catch</span>((error) <span class="kw">=&gt;</span> {</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">"AbortError"</span>) {</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>                <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>                <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (error) {</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSearchStatus</span>(<span class="st">""</span>)<span class="op">;</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// Clear selected XML when the search box is cleared</span></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handleSearch <span class="op">=</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setQuery</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// Clear selected XML when the search box is cleared</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (query<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSearchStatus</span>(<span class="st">""</span>)<span class="op">;</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setSearchStatus</span>(<span class="vs">`Searching for '</span><span class="sc">${</span>query<span class="sc">}</span><span class="vs">'...`</span>)<span class="op">;</span></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (abortControllerRef<span class="op">.</span><span class="at">current</span>) {</span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>      abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span> <span class="co">// Cancel any ongoing fetch requests</span></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>    abortControllerRef<span class="op">.</span><span class="at">current</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { signal } <span class="op">=</span> abortControllerRef<span class="op">.</span><span class="at">current</span><span class="op">;</span></span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> fetchData <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/offsets/</span><span class="sc">${</span>query<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>          <span class="dt">mode</span><span class="op">:</span> <span class="st">"cors"</span><span class="op">,</span></span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>          signal<span class="op">,</span></span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setResults</span>(data)<span class="op">;</span></span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> endTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> duration <span class="op">=</span> ((endTime <span class="op">-</span> startTime) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSearchStatus</span>(<span class="vs">`Received </span><span class="sc">${</span>data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> results for '</span><span class="sc">${</span>query<span class="sc">}</span><span class="vs">' in </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs"> seconds.`</span>)<span class="op">;</span></span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">"AbortError"</span>) {</span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching search results:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setResults</span>([])<span class="op">;</span></span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> timeoutId <span class="op">=</span> <span class="pp">setTimeout</span>(fetchData<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> () <span class="kw">=&gt;</span> <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> [query])<span class="op">;</span></span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This refactoring uses <code>useEffect</code> to handle the debounce logic, ensuring that the fetch request is only dispatched after the user has stopped typing for one second. This should prevent unnecessary fetch requests and improve performance.</p>
<blockquote class="blockquote">
<p>Tokens: 6.9k sent, 787 received. Cost: $0.03 message, $0.41 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 9289f8d refactor: Improve debounce logic for search requests using useEffect<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="when-a-search-result-is-clicked-on-and-setqueryname-is-called-a-new-offset-search-is-being-dispatched.-this-shouldnt-happen.-the-text-of-the-search-bar-should-be-set-but-no-actual-query-should-be-made.-hopefully-this-could-be-done-by-maybe-something-like-setqueryname-textonlytrue-or-something." class="level4">
<h4 class="anchored" data-anchor-id="when-a-search-result-is-clicked-on-and-setqueryname-is-called-a-new-offset-search-is-being-dispatched.-this-shouldnt-happen.-the-text-of-the-search-bar-should-be-set-but-no-actual-query-should-be-made.-hopefully-this-could-be-done-by-maybe-something-like-setqueryname-textonlytrue-or-something.">When a search result is clicked on and <code>setQuery(name)</code> is called… a new offset search is being dispatched. This shouldn’t happen. The “text” of the search bar should be set, but no actual query should be made. Hopefully this could be done by maybe something like <code>setQuery(name, textOnly=true)</code> or something.</h4>
<p>To prevent a new search from being dispatched when setting the query text from a search result click, we can introduce a new state variable to control whether the search should be triggered. Here’s how you can implement this:</p>
<ol type="1">
<li>Add a new state variable <code>shouldSearch</code> to control when the search should be triggered.</li>
<li>Modify the <code>handleSearch</code> function to set <code>shouldSearch</code> to <code>true</code> when the user types in the search box.</li>
<li>Update the <code>useEffect</code> hook to only perform the search if <code>shouldSearch</code> is <code>true</code>.</li>
<li>Set <code>shouldSearch</code> to <code>false</code> when setting the query from a search result click.</li>
</ol>
<p>Here are the changes:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [selectedXml<span class="op">,</span> setSelectedXml] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [selectedXml<span class="op">,</span> setSelectedXml] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [shouldSearch<span class="op">,</span> setShouldSearch] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setQuery</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setQuery</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setShouldSearch</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (query<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>shouldSearch <span class="op">||</span> query<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(xmlData)<span class="op">;</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(name)<span class="op">;</span> <span class="co">// Place the result's name into the search bar</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setShouldSearch</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setSelectedXml</span>(xmlData)<span class="op">;</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes ensure that the search is only triggered when the user types in the search box, and not when the query is set from a search result click.</p>
<blockquote class="blockquote">
<p>Tokens: 7.0k sent, 360 received. Cost: $0.02 message, $0.43 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 863cc96 feat: Prevent search dispatch when setting query from search result click<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="add-a-radio-button-with-two-states-xml-and-html-with-the-default-being-xml.-the-button-should-come-below-the-search-bar-before-the-status-line.-when-the-radio-button-is-set-to-xml-all-current-behavior-remains-the-same.-when-it-is-set-to-html-we-use-a-new-selectedhtml-component-and-the-url-is-httpdgx4444html-instead-of-httpdgx4444xml.-use-a-new-for-displaying-selectedhtml" class="level4">
<h4 class="anchored" data-anchor-id="add-a-radio-button-with-two-states-xml-and-html-with-the-default-being-xml.-the-button-should-come-below-the-search-bar-before-the-status-line.-when-the-radio-button-is-set-to-xml-all-current-behavior-remains-the-same.-when-it-is-set-to-html-we-use-a-new-selectedhtml-component-and-the-url-is-httpdgx4444html-instead-of-httpdgx4444xml.-use-a-new-for-displaying-selectedhtml">Add a radio button with two states, XML and HTML, with the default being XML. The button should come below the search bar, before the status line. When the radio button is set to XML, all current behavior remains the same. When it is set to HTML, we use a new selectedHtml component, and the URL is <code>http://dgx:4444/html</code> instead of <code>http://dgx:4444/xml</code>. Use a new <card> for displaying {selectedHtml &amp;&amp; …</card></h4>
<blockquote class="blockquote">
<p>http://dgx:4444/html<code>Add URL to the chat? (Y)es/(N)o/(A)ll/(S)kip all/(D)on't ask again [Yes]: n   http://dgx:4444/xml</code><br>
Add URL to the chat? (Y)es/(N)o/(A)ll/(S)kip all/(D)on’t ask again [Yes]: n</p>
</blockquote>
<p>To implement the requested changes, we need to update <code>src/Wiki.jsx</code> to:</p>
<ol type="1">
<li>Add a radio button group to toggle between XML and HTML.</li>
<li>Introduce a new state variable to track the selected format.</li>
<li>Modify the <code>handleResultClick</code> function to fetch data from the appropriate URL based on the selected format.</li>
<li>Render the selected content in a new <code>&lt;Card&gt;</code> for HTML.</li>
</ol>
<p>Here are the <em>SEARCH/REPLACE</em> blocks:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Container<span class="op">,</span> Form<span class="op">,</span> FormControl<span class="op">,</span> ListGroup<span class="op">,</span> Card } <span class="im">from</span> <span class="st">"react-bootstrap"</span><span class="op">;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Container<span class="op">,</span> Form<span class="op">,</span> FormControl<span class="op">,</span> ListGroup<span class="op">,</span> Card<span class="op">,</span> FormCheck } <span class="im">from</span> <span class="st">"react-bootstrap"</span><span class="op">;</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [shouldSearch<span class="op">,</span> setShouldSearch] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [format<span class="op">,</span> setFormat] <span class="op">=</span> <span class="fu">useState</span>(<span class="st">"XML"</span>)<span class="op">;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [shouldSearch<span class="op">,</span> setShouldSearch] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [selectedHtml<span class="op">,</span> setSelectedHtml] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle item click and fetch XML data</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle item click and fetch data based on selected format</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`http://dgx:4444/xml`</span><span class="op">,</span> {</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> url <span class="op">=</span> format <span class="op">===</span> <span class="st">"XML"</span> <span class="op">?</span> <span class="st">"http://dgx:4444/xml"</span> <span class="op">:</span> <span class="st">"http://dgx:4444/html"</span><span class="op">;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> {</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> xmlData <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(name)<span class="op">;</span> <span class="co">// Place the result's name into the search bar</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(name)<span class="op">;</span> <span class="co">// Place the result's name into the search bar</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setShouldSearch</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (format <span class="op">===</span> <span class="st">"XML"</span>) {</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedXml</span>(data)<span class="op">;</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedHtml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedHtml</span>(data)<span class="op">;</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>Form<span class="op">&gt;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>Form className<span class="op">=</span><span class="st">"mb-3"</span><span class="op">&gt;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>      {query <span class="op">&amp;&amp;</span> (</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>FormCheck</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>        type<span class="op">=</span><span class="st">"radio"</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"XML"</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"format"</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        id<span class="op">=</span><span class="st">"xml-radio"</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>        checked<span class="op">=</span>{format <span class="op">===</span> <span class="st">"XML"</span>}</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>        onChange<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">setFormat</span>(<span class="st">"XML"</span>)}</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>        className<span class="op">=</span><span class="st">"mt-2"</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">/&gt;</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>FormCheck</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>        type<span class="op">=</span><span class="st">"radio"</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"HTML"</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"format"</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>        id<span class="op">=</span><span class="st">"html-radio"</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>        checked<span class="op">=</span>{format <span class="op">===</span> <span class="st">"HTML"</span>}</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>        onChange<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">setFormat</span>(<span class="st">"HTML"</span>)}</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>        className<span class="op">=</span><span class="st">"mb-2"</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">/&gt;</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>      {query <span class="op">&amp;&amp;</span> searchStatus <span class="op">&amp;&amp;</span> (</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>Container<span class="op">&gt;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>      {selectedHtml <span class="op">&amp;&amp;</span> (</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>Card className<span class="op">=</span><span class="st">"mt-3"</span><span class="op">&gt;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>Card<span class="op">.</span><span class="at">Body</span><span class="op">&gt;</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>div dangerouslySetInnerHTML<span class="op">=</span>{{ <span class="dt">__html</span><span class="op">:</span> selectedHtml }} <span class="op">/&gt;</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;/</span>Card<span class="op">.</span><span class="at">Body</span><span class="op">&gt;</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>Card<span class="op">&gt;</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>      )}</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>Container<span class="op">&gt;</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will add a radio button group to toggle between XML and HTML formats, fetch data from the appropriate URL, and display the content accordingly.</p>
<blockquote class="blockquote">
<p>Tokens: 6.4k sent, 706 received. Cost: $0.02 message, $0.46 session.<br>
Committing src/Wiki.jsx before applying edits.<br>
Commit 2280058 style: Format search status and results list for better readability<br>
Applied edit to src/Wiki.jsx<br>
Commit 850857a feat: Add radio button to toggle between XML and HTML formats<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="make-sure-the-wiki-tab-is-always-activated-whenever-the-page-first-loads-or-reloads.-im-not-sure-if-this-should-be-handled-in-srcapp.jsx." class="level4">
<h4 class="anchored" data-anchor-id="make-sure-the-wiki-tab-is-always-activated-whenever-the-page-first-loads-or-reloads.-im-not-sure-if-this-should-be-handled-in-srcapp.jsx.">Make sure the ‘Wiki’ tab is always “activated” whenever the page first loads (or reloads). I’m not sure if this should be handled in src/App.jsx.</h4>
<p>To ensure the ‘Wiki’ tab is always activated when the page first loads or reloads, we need to set the <code>defaultActiveKey</code> to “wiki” in the <code>Tabs</code> component within <code>src/App.jsx</code>. Here is the necessary change:</p>
<p>src/App.jsx</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>Tabs defaultActiveKey<span class="op">=</span><span class="st">"stats"</span> id<span class="op">=</span><span class="st">"main-tabs"</span><span class="op">&gt;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>Tabs defaultActiveKey<span class="op">=</span><span class="st">"wiki"</span> id<span class="op">=</span><span class="st">"main-tabs"</span><span class="op">&gt;</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change will ensure that the ‘Wiki’ tab is the default active tab whenever the page is loaded.</p>
<blockquote class="blockquote">
<p>Tokens: 7.4k sent, 116 received. Cost: $0.02 message, $0.48 session.<br>
Committing src/App.jsx before applying edits.<br>
Commit 10b02e1 fix: Remove Stats tab from the main application view<br>
Applied edit to src/App.jsx<br>
Commit 61a843b feat: Set ‘Wiki’ tab as default active tab on page load<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="multi" class="level4">
<h4 class="anchored" data-anchor-id="multi">/multi</h4>
<blockquote class="blockquote">
<p>Multiline mode: Enabled. Enter inserts newline, Alt-Enter submits text</p>
</blockquote>
</section>
<section id="add-srcutils.jsx" class="level4">
<h4 class="anchored" data-anchor-id="add-srcutils.jsx">/add src/Utils.jsx</h4>
<blockquote class="blockquote">
<p>Added src/Utils.jsx to the chat</p>
</blockquote>
</section>
<section id="verify-if-srcutils.jsx-is-correct-i-am-using-it-as-a-jsx-module-for-helper-routines." class="level4">
<h4 class="anchored" data-anchor-id="verify-if-srcutils.jsx-is-correct-i-am-using-it-as-a-jsx-module-for-helper-routines.">Verify if src/Utils.jsx is correct; I am using it as a JSX module for helper routines.</h4>
<p>To ensure <code>src/Utils.jsx</code> is correctly set up as a JSX module for helper routines, we need to ensure it exports the <code>bytesToHuman</code> function. Here’s the necessary change:</p>
<p>src/Utils.jsx</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bytesToHuman</span>(bytes) {</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">bytesToHuman</span>(bytes) {</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This change will export the <code>bytesToHuman</code> function, making it available for import in other modules.</p>
<blockquote class="blockquote">
<p>Tokens: 7.7k sent, 93 received. Cost: $0.02 message, $0.50 session.<br>
Committing src/Utils.jsx before applying edits.<br>
Commit 98a54f5 feat: Add Utils component for utility functions<br>
Applied edit to src/Utils.jsx<br>
Commit b7c8aec feat: Export bytesToHuman function from Utils module for usage in other files<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="alter-the-search-results-such-that-after-each-text-component-is-displayed-the-size-of-the-article-is-calculated-via-last-byte---first-byte-and-then-displayed-as-bytestohumansize-e.g.-if-the-search-result-item-ispython-programming-language-it-should-now-displaypython-programming-language-3.8-mb-assuming-3.8-mb-is-returned-by-the-bytestohuman-routine." class="level4">
<h4 class="anchored" data-anchor-id="alter-the-search-results-such-that-after-each-text-component-is-displayed-the-size-of-the-article-is-calculated-via-last-byte---first-byte-and-then-displayed-as-bytestohumansize-e.g.-if-the-search-result-item-ispython-programming-language-it-should-now-displaypython-programming-language-3.8-mb-assuming-3.8-mb-is-returned-by-the-bytestohuman-routine.">Alter the search results such that after each text component is displayed, the size of the article is calculated (via last byte - first byte), and then displayed as ” [{bytesToHuman(size)}]“, e.g.&nbsp;if the search result item is”Python (programming language)“, it should now display”Python (programming language) [3.8 MB]” (assuming “3.8 MB” is returned by the <code>bytesToHuman()</code> routine).</h4>
<p>To display the size of each article in the search results, we need to calculate the size using the difference between <code>endByte</code> and <code>startByte</code>, and then format it using the <code>bytesToHuman</code> function. Here’s how you can implement this:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>        {results<span class="op">.</span><span class="fu">map</span>(([name<span class="op">,</span> startByte<span class="op">,</span> endByte]) <span class="kw">=&gt;</span> (</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>ListGroup<span class="op">.</span><span class="at">Item</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span>{<span class="vs">`</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>startByte<span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>            action</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>            onClick<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">handleResultClick</span>(name<span class="op">,</span> startByte<span class="op">,</span> endByte)}</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>          <span class="op">&gt;</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>            {name}</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;/</span>ListGroup<span class="op">.</span><span class="at">Item</span><span class="op">&gt;</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>        ))}</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>        {results<span class="op">.</span><span class="fu">map</span>(([name<span class="op">,</span> startByte<span class="op">,</span> endByte]) <span class="kw">=&gt;</span> {</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> size <span class="op">=</span> endByte <span class="op">-</span> startByte<span class="op">;</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> (</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>ListGroup<span class="op">.</span><span class="at">Item</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>              key<span class="op">=</span>{<span class="vs">`</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>startByte<span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>              action</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>              onClick<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">handleResultClick</span>(name<span class="op">,</span> startByte<span class="op">,</span> endByte)}</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">&gt;</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>              {name} [{<span class="fu">bytesToHuman</span>(size)}]</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;/</span>ListGroup<span class="op">.</span><span class="at">Item</span><span class="op">&gt;</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>        })}</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Tokens: 6.7k sent, 208 received. Cost: $0.02 message, $0.52 session.<br>
Committing src/Wiki.jsx before applying edits.<br>
Commit a64ef15 refactor: Improve code formatting and clean up unused components in Wiki.jsx<br>
Applied edit to src/Wiki.jsx<br>
Commit 2e5d371 feat: Display article size in search results using bytesToHuman function<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="add-additional-code-to-the-status-line-that-displays-the-following-after-an-xml-document-has-been-received-received-bytestohumancontent-length-in-x.yz-seconds.." class="level4">
<h4 class="anchored" data-anchor-id="add-additional-code-to-the-status-line-that-displays-the-following-after-an-xml-document-has-been-received-received-bytestohumancontent-length-in-x.yz-seconds..">Add additional code to the status line that displays the following after an XML document has been received: “Received {bytesToHuman(content-length)} in x.yz seconds.”.</h4>
<p>To display the content length in the status line after receiving an XML document, we need to update the <code>handleResultClick</code> function in <code>src/Wiki.jsx</code>. We’ll calculate the content length from the response headers and update the status message accordingly.</p>
<p>Here’s the necessary change:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setShouldSearch</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(name)<span class="op">;</span> <span class="co">// Place the result's name into the search bar</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">//setShouldSearch(true);</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (format <span class="op">===</span> <span class="st">"XML"</span>) {</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedXml</span>(data)<span class="op">;</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedHtml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedHtml</span>(data)<span class="op">;</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span> <span class="co">// Clear results when an item is clicked</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> contentLength <span class="op">=</span> response<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="fu">get</span>(<span class="st">"Content-Length"</span>)<span class="op">;</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> endTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> duration <span class="op">=</span> ((endTime <span class="op">-</span> startTime) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setShouldSearch</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setQuery</span>(name)<span class="op">;</span> <span class="co">// Place the result's name into the search bar</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (format <span class="op">===</span> <span class="st">"XML"</span>) {</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedXml</span>(data)<span class="op">;</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedHtml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSearchStatus</span>(</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>          <span class="vs">`Received </span><span class="sc">${</span><span class="fu">bytesToHuman</span>(contentLength)<span class="sc">}</span><span class="vs"> in </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs"> seconds.`</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedHtml</span>(data)<span class="op">;</span></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setSelectedXml</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setResults</span>([])<span class="op">;</span> <span class="co">// Clear results when an item is clicked</span></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Tokens: 7.0k sent, 297 received. Cost: $0.02 message, $0.54 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit be53a22 feat: Display content length and duration in status line after XML receipt<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="fix-this-error" class="level4">
<h4 class="anchored" data-anchor-id="fix-this-error">Fix this error:</h4>
</section>
<section id="eslint" class="level4">
<h4 class="anchored" data-anchor-id="eslint">[eslint]</h4>
</section>
<section id="srcwiki.jsx" class="level4">
<h4 class="anchored" data-anchor-id="srcwiki.jsx">src/Wiki.jsx</h4>
</section>
<section id="line-8736-starttime-is-not-defined-no-undef" class="level4">
<h4 class="anchored" data-anchor-id="line-8736-starttime-is-not-defined-no-undef">Line 87:36: ‘startTime’ is not defined no-undef</h4>
<p>To fix the error, we need to ensure that <code>startTime</code> is defined within the scope of the <code>handleResultClick</code> function. It seems like <code>startTime</code> was intended to be used to measure the duration of the fetch operation, but it wasn’t defined in the function. We should define <code>startTime</code> at the beginning of the <code>handleResultClick</code> function.</p>
<p>Here’s the change:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Tokens: 7.5k sent, 108 received. Cost: $0.02 message, $0.56 session.<br>
Applied edit to src/Wiki.jsx<br>
Commit 14907ab fix: Define ‘startTime’ in handleResultClick to resolve no-undef error<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="change-the-selectedxml-style-so-that-the-lines-wrap." class="level4">
<h4 class="anchored" data-anchor-id="change-the-selectedxml-style-so-that-the-lines-wrap.">Change the selectedXml style so that the lines wrap.</h4>
<p>To enable line wrapping for the <code>selectedXml</code> content, we need to adjust the <code>SyntaxHighlighter</code> component’s style. We can achieve this by setting the <code>wrapLongLines</code> property to <code>true</code>.</p>
<p>Here’s the change:</p>
<p>src/Wiki.jsx</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> SEARCH</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>SyntaxHighlighter language<span class="op">=</span><span class="st">"xml"</span> style<span class="op">=</span>{solarizedlight}<span class="op">&gt;</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="op">=======</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>SyntaxHighlighter language<span class="op">=</span><span class="st">"xml"</span> style<span class="op">=</span>{solarizedlight} wrapLongLines<span class="op">=</span>{<span class="kw">true</span>}<span class="op">&gt;</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Tokens: 7.7k sent, 102 received. Cost: $0.02 message, $0.58 session.<br>
Committing src/Wiki.jsx before applying edits.<br>
Commit 083bfad refactor: Improve search status handling and conditionally render results<br>
Applied edit to src/Wiki.jsx<br>
Commit eee4498 feat: Enable line wrapping for selectedXml in SyntaxHighlighter component<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
<section id="that-didnt-appear-to-do-anything.-can-you-review-the-app.scss-or-app.css-and-see-if-anything-can-be-done-there" class="level4">
<h4 class="anchored" data-anchor-id="that-didnt-appear-to-do-anything.-can-you-review-the-app.scss-or-app.css-and-see-if-anything-can-be-done-there">That didn’t appear to do anything. Can you review the App.scss or App.css and see if anything can be done there?</h4>
<p>To improve the styling of the <code>selectedXml</code> content for better readability, we can adjust the CSS in <code>src/App.scss</code> to ensure proper line wrapping and spacing. Let’s add some styles to enhance the display of the XML content.</p>
<p>Here’s the <em>SEARCH/REPLACE</em> block for <code>src/App.scss</code>:</p>
<p>src/App.scss</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode scss code-with-copy"><code class="sourceCode scss"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>&lt;&lt;&lt;&lt;&lt;&lt;&lt; SEARCH</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> <span class="fu">.list-group-item</span> {</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">white-space</span>: <span class="dv">normal</span><span class="op">;</span> <span class="co">// Allow text to wrap</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>=======</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> <span class="fu">.list-group-item</span> {</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">white-space</span>: <span class="dv">normal</span><span class="op">;</span> <span class="co">// Allow text to wrap</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="fu">.wiki-search-container</span> <span class="fu">.card-body</span> {</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">white-space</span>: <span class="dv">pre-wrap</span><span class="op">;</span> <span class="co">// Preserve whitespace and wrap lines</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    word-wrap: <span class="dv">break-word</span><span class="op">;</span> <span class="co">// Break long words</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">overflow-wrap</span>: <span class="dv">break-word</span><span class="op">;</span> <span class="co">// Ensure long words break</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">line-height</span>: <span class="dv">1.5</span><span class="op">;</span> <span class="co">// Improve readability with line height</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> REPLACE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These changes will ensure that the XML content is displayed with proper line wrapping and spacing, making it easier to read.</p>
<blockquote class="blockquote">
<p>Tokens: 6.5k sent, 212 received. Cost: $0.02 message, $0.59 session.<br>
Applied edit to src/App.scss<br>
Commit 3cef238 style: Improve readability of selected XML content in App.scss<br>
You can use /undo to undo and discard each aider commit.</p>
</blockquote>
</section>
</section>
</section>
</div>
</div>
</div>
</section>
</section>
<section id="pytorch-deep-neural-networks-llms-and-andrej-karpathys-youtube-series" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-deep-neural-networks-llms-and-andrej-karpathys-youtube-series">PyTorch, Deep Neural Networks, LLMs, and Andrej Karpathy’s YouTube Series</h2>
</section>
</section>
<section id="comments" class="level1">
<h1>Comments</h1>
<!-- vim:set ts=8 sw=2 sts=2 expandtab textwidth=79 -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/trent\.me");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="tpn/website" data-repo-id="MDEwOlJlcG9zaXRvcnkxMjg2ODc3NTQ=" data-category="Announcements" data-category-id="DIC_kwDOB6ueis4Cj53i" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="dark">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tpn/website/edit/main/articles/from-pyparallel-to-python-free-threading/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/tpn/website/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>